/*******************************************************
* Copyright (C) 2018-2022 WP Interactive Media, Inc. - All Rights Reserved
* Unauthorized copying of this file, via any medium is strictly prohibited
* Proprietary and confidential
*******************************************************/
(()=>{var t={63:(t,e)=>{function s(t){if(t)return function(t){for(var e in s.prototype)t[e]=s.prototype[e];return t}(t)}e.Q=s,s.prototype.on=s.prototype.addEventListener=function(t,e){return this.t=this.t||{},(this.t["$"+t]=this.t["$"+t]||[]).push(e),this},s.prototype.once=function(t,e){function s(){this.off(t,s),e.apply(this,arguments)}return s.fn=e,this.on(t,s),this},s.prototype.off=s.prototype.removeListener=s.prototype.removeAllListeners=s.prototype.removeEventListener=function(t,e){if(this.t=this.t||{},0==arguments.length)return this.t={},this;var s,i=this.t["$"+t];if(!i)return this;if(1==arguments.length)return delete this.t["$"+t],this;for(var n=0;n<i.length;n++)if((s=i[n])===e||s.fn===e){i.splice(n,1);break}return 0===i.length&&delete this.t["$"+t],this},s.prototype.emit=function(t){this.t=this.t||{};for(var e=new Array(arguments.length-1),s=this.t["$"+t],i=1;i<arguments.length;i++)e[i-1]=arguments[i];if(s){i=0;for(var n=(s=s.slice(0)).length;i<n;++i)s[i].apply(this,e)}return this},s.prototype.emitReserved=s.prototype.emit,s.prototype.listeners=function(t){return this.t=this.t||{},this.t["$"+t]||[]},s.prototype.hasListeners=function(t){return!!this.listeners(t).length}},10:t=>{function e(t){t=t||{},this.ms=t.min||100,this.max=t.max||1e4,this.factor=t.factor||2,this.jitter=t.jitter>0&&t.jitter<=1?t.jitter:0,this.attempts=0}t.exports=e,e.prototype.duration=function(){var t=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var e=Math.random(),s=Math.floor(e*this.jitter*t);t=0==(1&Math.floor(10*e))?t-s:t+s}return 0|Math.min(t,this.max)},e.prototype.reset=function(){this.attempts=0},e.prototype.setMin=function(t){this.ms=t},e.prototype.setMax=function(t){this.max=t},e.prototype.setJitter=function(t){this.jitter=t}},58:t=>{try{t.exports="undefined"!=typeof XMLHttpRequest&&"withCredentials"in new XMLHttpRequest}catch(e){t.exports=!1}},830:(t,e)=>{e.encode=function(t){var e="";for(var s in t)t.hasOwnProperty(s)&&(e.length&&(e+="&"),e+=encodeURIComponent(s)+"="+encodeURIComponent(t[s]));return e},e.decode=function(t){for(var e={},s=t.split("&"),i=0,n=s.length;i<n;i++){var o=s[i].split("=");e[decodeURIComponent(o[0])]=decodeURIComponent(o[1])}return e}},187:t=>{var e=/^(?:(?![^:@]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,s=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];t.exports=function(t){var i=t,n=t.indexOf("["),o=t.indexOf("]");-1!=n&&-1!=o&&(t=t.substring(0,n)+t.substring(n,o).replace(/:/g,";")+t.substring(o,t.length));for(var r,c,h=e.exec(t||""),a={},l=14;l--;)a[s[l]]=h[l]||"";return-1!=n&&-1!=o&&(a.source=i,a.host=a.host.substring(1,a.host.length-1).replace(/;/g,":"),a.authority=a.authority.replace("[","").replace("]","").replace(/;/g,":"),a.ipv6uri=!0),a.pathNames=function(t,e){var s=/\/{2,9}/g,i=e.replace(s,"/").split("/");"/"!=e.substr(0,1)&&0!==e.length||i.splice(0,1);"/"==e.substr(e.length-1,1)&&i.splice(i.length-1,1);return i}(0,a.path),a.queryKey=(r=a.query,c={},r.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,(function(t,e,s){e&&(c[e]=s)})),c),a}},281:t=>{"use strict";var e,s="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split(""),i={},n=0,o=0;function r(t){var e="";do{e=s[t%64]+e,t=Math.floor(t/64)}while(t>0);return e}function c(){var t=r(+new Date);return t!==e?(n=0,e=t):t+"."+r(n++)}for(;o<64;o++)i[s[o]]=o;c.encode=r,c.decode=function(t){var e=0;for(o=0;o<t.length;o++)e=64*e+i[t.charAt(o)];return e},t.exports=c}},e={};function s(i){var n=e[i];if(void 0!==n)return n.exports;var o=e[i]={exports:{}};return t[i](o,o.exports,s),o.exports}s.d=(t,e)=>{for(var i in e)s.o(e,i)&&!s.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},s.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),s.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"i",{value:!0})};var i={};(()=>{"use strict";s.d(i,{Z:()=>qe});var t={};s.r(t),s.d(t,{Decoder:()=>Yt,Encoder:()=>Zt,PacketType:()=>qt,protocol:()=>Xt});var e=console.log.bind(window.console);const n=new class{constructor(){this.h=new Map}setSocketForTabId(t,e){this.h.set(t,e)}getSocketForTabId(t){return this.h.get(t)}containsSocketForTabId(t){return this.h.has(t)}removeSocketForTabId(t){this.h.delete(t)}teardown(){this.h.forEach((t=>{t.teardown()})),this.h.clear()}};Object.freeze(n);const o=n;var r;!function(t){t.JOIN_SESSION="joinSession",t.GET_VIDEO_DATA="getVideoData",t.LOAD_SESSION="loadSession",t.NO_SESSION_DATA="noSessionData",t.TEARDOWN="teardown",t.ON_VIDEO_UPDATE="onVideoUpdate",t.SOCKET_LOST_CONNECTION="socketLostConnection",t.REBOOT="socketReconnect",t.LOG_EVENT="logEvent",t.LOG_EXPERIMENT="logExpirement",t.STAY_ALIVE="stayAlive",t.LOAD_CHAT_WINDOW="loadChatWindow",t.RESET_CHAT_WINDOW="resetChatWindow",t.HIDE_CHAT_WINDOW="hideChatWindow"}(r||(r={}));const c="Failed to read chrome storage. Please refresh the page and try again";var h=function(t,e,s,i){return new(s||(s=Promise))((function(n,o){function r(t){try{h(i.next(t))}catch(t){o(t)}}function c(t){try{h(i.throw(t))}catch(t){o(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(r,c)}h((i=i.apply(t,e||[])).next())}))};const a=new class{getItemsAsync(t){return h(this,void 0,void 0,(function*(){return new Promise(((e,s)=>{chrome.storage.local.get(t,(t=>{chrome.runtime.lastError?s(new Error(c)):e(t)}))}))}))}getAllItemsAsync(){return h(this,void 0,void 0,(function*(){return new Promise(((t,e)=>{chrome.storage.local.get(null,(s=>{chrome.runtime.lastError?e(new Error(c)):t(s)}))}))}))}};Object.freeze(a);const l=a,u=368,d=(chrome.extension.getURL("img/x-circle.svg"),["Batman.svg","DeadPool.svg","CptAmerica.svg","Wolverine.svg","IronMan.svg","Goofy.svg","Alien.svg","Mulan.svg","Snow-White.svg","Poohbear.svg","Sailormoon.svg","Sailor Cat.svg","Pizza.svg","Cookie.svg","Chocobar.svg","hotdog.svg","Hamburger.svg","Popcorn.svg","IceCream.svg","ChickenLeg.svg"]),f=["General/Alien.svg","General/Batman.svg","General/ChickenLeg.svg","General/Chocobar.svg","General/Cookie.svg","General/CptAmerica.svg","General/DeadPool.svg","General/Goofy.svg","General/Hamburger.svg","General/hotdog.svg","General/IceCream.svg","General/IronMan.svg","General/Mulan.svg","General/Pizza.svg","General/Poohbear.svg","General/Popcorn.svg","General/Sailor Cat.svg","General/Sailormoon.svg","General/Snow-White.svg","General/Wolverine.svg"],v=["General/Alien.svg","General/Batman.svg","General/ChickenLeg.svg","General/Chocobar.svg","General/Cookie.svg","General/CptAmerica.svg","General/DeadPool.svg","General/Goofy.svg","General/Hamburger.svg","General/hotdog.svg","General/IceCream.svg","General/IronMan.svg","General/Mulan.svg","General/Pizza.svg","General/Poohbear.svg","General/Popcorn.svg","General/Sailor Cat.svg","General/Sailormoon.svg","General/Snow-White.svg","General/Wolverine.svg","Christmas/angel.svg","Christmas/bell.svg","Christmas/box.svg","Christmas/cane.svg","Christmas/flake.svg","Christmas/gingerbread.svg","Christmas/gingerbread_F.svg","Christmas/gingerbread_M.svg","Christmas/gloves_blue.svg","Christmas/gloves_red.svg","Christmas/hat.svg","Christmas/ornament.svg","Christmas/raindeer.svg","Christmas/reef.svg","Christmas/santa_F.svg","Christmas/santa_M.svg","Christmas/snowglobe.svg","Christmas/snowman.svg","Christmas/sock.svg","Christmas/tree.svg","Halloween/bats.svg","Halloween/candy_corn.svg","Halloween/cat_black.svg","Halloween/cat_white.svg","Halloween/coffin.svg","Halloween/eye_ball.svg","Halloween/face_angry.svg","Halloween/face_evil.svg","Halloween/face_silly.svg","Halloween/face_smile.svg","Halloween/frankenstein.svg","Halloween/ghost_F.svg","Halloween/ghost_M.svg","Halloween/gravestone.svg","Halloween/lollipop.svg","Halloween/moon.svg","Halloween/mummy.svg","Halloween/potion.svg","Halloween/pumpkin.svg","Halloween/pumpkin_witch.svg","Halloween/skull_brain.svg","Halloween/skull_candy.svg","Halloween/skull_girl.svg","Halloween/witch_hat.svg","Thanksgiving/acorn.svg","Thanksgiving/bread.svg","Thanksgiving/candles.svg","Thanksgiving/corn.svg","Thanksgiving/drinks.svg","Thanksgiving/maple_leaf.svg","Thanksgiving/plate_chicken.svg","Thanksgiving/pumpkin.svg","Thanksgiving/pumpkin_pie.svg","Thanksgiving/slice_pie.svg","Thanksgiving/sun_flower.svg","Thanksgiving/turkey_face.svg"];var p=function(t,e,s,i){return new(s||(s=Promise))((function(n,o){function r(t){try{h(i.next(t))}catch(t){o(t)}}function c(t){try{h(i.throw(t))}catch(t){o(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(r,c)}h((i=i.apply(t,e||[])).next())}))};const g=new class{setItemsAsync(t){return p(this,void 0,void 0,(function*(){return new Promise(((e,s)=>{chrome.storage.local.set(t,(()=>{chrome.runtime.lastError?s(new Error("Failed to write to chrome storage. Please refresh the page and try again")):e()}))}))}))}};Object.freeze(g);const m=g;var y=function(t,e,s,i){return new(s||(s=Promise))((function(n,o){function r(t){try{h(i.next(t))}catch(t){o(t)}}function c(t){try{h(i.throw(t))}catch(t){o(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(r,c)}h((i=i.apply(t,e||[])).next())}))};const w=new class{isUserIconValid(t){return!!t&&(t.includes("?newIconUrl=")?v.includes(t.split("?newIconUrl=")[1])&&d.includes(t.split("?newIconUrl=")[0]):v.includes(t))}isUserIdValid(t){return"string"==typeof t&&(16===t.length||36===t.length)}isUserNickNameValid(t){return t&&"string"==typeof t&&t.length<20}getDefaultUserIcon(){return f[Math.floor(Math.random()*f.length)]}getDefaultUserNickName(){return""}l(t){return y(this,void 0,void 0,(function*(){try{yield m.setItemsAsync(t)}catch(t){}}))}getValidatedChromeStorageDataAsync(){return y(this,void 0,void 0,(function*(){const t=yield l.getAllItemsAsync(),e=w.validateStorageData(t);return t!==e&&(yield this.l(e)),e}))}validateStorageData(t){const e="object"==typeof t?Object.assign({},t):{};return e.userIcon&&e.userIcon.includes("?newIconUrl=")&&(e.userIcon=e.userIcon.split("?newIconUrl=")[1]),this.isUserIconValid(e.userIcon)||(e.userIcon=this.getDefaultUserIcon()),this.isUserNickNameValid(e.userNickname)||(e.userNickname=this.getDefaultUserNickName()),e}};Object.freeze(w);const b=w,_="Service_Background",k="Content_Script";const S=chrome.runtime.id,T=[".netflix.",".disneyplus.",".hbomax.",".hulu.",".amazon.",".primevideo.",".youtube.",".paramountplus.",".funimation.",".peacocktv.",".crunchyroll.",".fubo.tv",".espn.",".showtime.",".amcplus.",".hotstar.","tv.apple.","tubitv.com",".sling.",".philo."],C="wss://ws.teleparty.com",I="redirectDataMap",A="https://redirect.teleparty.com/sidebar";const E=new class{addListener(t){chrome.runtime.onMessage.addListener(t)}removeListener(t){chrome.runtime.onMessage.removeListener(t)}sendMessageToTabAsync(t,s,i=2e4){return new Promise(((n,o)=>{const r=setTimeout((()=>{o()}),i);try{chrome.tabs.sendMessage(s,t,(s=>{chrome.runtime.lastError&&e(chrome.runtime.lastError.message+JSON.stringify(t)),clearTimeout(r),n(s)}))}catch(t){clearTimeout(r),o(t)}}))}u(t,e){return new Promise(((s,i)=>{let n=null;e&&(n=setTimeout((()=>{i({error:"Send Message Timeout"})}),e));try{chrome.runtime.sendMessage(S,t,(e=>{chrome.runtime.lastError&&console.log(chrome.runtime.lastError.message+JSON.stringify(t)),n&&clearTimeout(n),s(e)}))}catch(t){n&&clearTimeout(n),i(t)}}))}};class x{constructor(t,e,s){this.sender=t,this.target=e,this.type=s}}class P extends x{constructor(t,e,s){super(t,e,s),this.type=s}}class D extends P{constructor(t,e,s){super(t,e,r.LOAD_SESSION),this.data=s}}var O,j,M;!function(t){t.CREATE_SESSION="createSession",t.JOIN_SESSION="joinSession",t.UPDATE_SESSION="updateSession",t.NEXT_EPISODE_MESSAGE="nextEpisode",t.REBOOT_MESSAGE="reboot",t.SEND_MESSAGE="sendMessage",t.JUMP_TO_NEXT_EPISODE="jumpToNextEpisode",t.BUFFERING_MESSAGE="buffering",t.TYPING_MESSAGE="typing",t.SET_BUFFERING_PRESENCE="setBufferingPresence",t.SET_TYPING_PRESENCE="setTypingPresence",t.BROADCAST_USER_SETTINGS="broadcastUserSettings",t.UPDATE_SETTINGS_MESSAGE="updateSettings",t.SET_ADS_PRESENCE="setAdsPresence",t.GET_SERVER_TIME="getServerTime",t.LEAVE_SESSION="leaveSession",t.SEND_REACTION="sendReaction",t.SEND_GIF="sendGIF"}(O||(O={}));class U{constructor(t,e,s,i,n){this.requiredPermissions=t,this.serverName=s,this.name=i,this.contentScripts=e,this.syncFromEnd=n}urlWithSessionId(t){return`https://redirect.teleparty.com/join/${t}`}}function R(t){return t.hostname.includes(".netflix.")&&t.pathname.includes("/watch")}function N(t){return t.includes("urn:hbo:feature")?M.HBO_FEATURE:t.includes("urn:hbo:episode")||t.includes("urn:hbo:page:")&&t.includes(":type:episode")?M.HBO_EPISODE:t.includes("urn:hbo:extra")?M.HBO_EXTRA:M.NONE}function W(t){return function(){return new Promise((e=>{setTimeout((()=>{e()}),t)}))}}!function(t){t.NETFLIX="NETFLIX",t.HULU="HULU",t.DISNEY_PLUS="DISNEY_PLUS",t.HBO_MAX="HBO_MAX",t.YOUTUBE="YOUTUBE",t.AMAZON="AMAZON"}(j||(j={})),function(t){t.HBO_EPISODE="episode",t.HBO_FEATURE="feature",t.HBO_EXTRA="extra",t.NONE="none"}(M||(M={}));const F=new class extends U{isValidUrl(t){return R(t)}getVideoId(t){const e=t.pathname.match(/^.*\/([0-9]+)\??.*/);return e&&e.length>0?e[1]:void 0}getFullscreenScript(){return'\n            (function() {\n                var sizingWrapper = document.getElementsByClassName("sizing-wrapper")[0];\n                    if (sizingWrapper) {\n                        sizingWrapper.requestFullscreen = function() {}\n                        document.getElementsByClassName(\'button-nfplayerFullscreen\')[0].onclick = function() {\n                            var fullScreenWrapper = document.getElementsByClassName("nf-kb-nav-wrapper")[0];\n                            fullScreenWrapper.webkitRequestFullScreen(fullScreenWrapper.ALLOW_KEYBOARD_INPUT);\n                        }\n                    }\n            })();\n        '}}([],["content_scripts/netflix/netflix_content_bundled.js"],"netflix",j.NETFLIX,!1);Object.freeze(F);const G=F;const L=new class extends U{isValidUrl(t){return function(t){return t.hostname.includes(".hulu.")&&t.pathname.includes("/watch")}(t)}getVideoId(t){const e=t.pathname.match(/^.*\/([a-z\-0-9]+)\??.*/);return e&&e.length>0?e[1]:void 0}}([],["content_scripts/hulu/hulu_content_bundled.js"],"hulu",j.HULU,!1);Object.freeze(L);const B=L;const H=new class extends U{isValidUrl(t){return function(t){return t.hostname.includes(".disneyplus.")&&t.pathname.includes("/video")}(t)}getVideoId(t){const e=t.pathname.match(/^.*\/([a-z\-0-9]+)\??.*/);return e&&e.length>0?e[1]:void 0}}([],["content_scripts/disney/disney_content_bundled.js"],"disney",j.DISNEY_PLUS,!1);Object.freeze(H);const V=H;const z=new class extends U{isValidUrl(t){return function(t){return t.hostname.includes(".hbomax.")&&"none"!==N(t.pathname)||t.pathname.includes("urn:hbo:page")}(t)}getVideoId(t){const e="urn:hbo:"+N(t.pathname)+":",s=t.pathname.split(e);let i=null!=s&&s.length>1&&null!=s[1]?s[1].match(/^([a-zA-Z\-_0-9]+)\??.*/):null;const n=null!=i&&0!==i.length?s[1].match(/^([a-zA-Z\-_0-9]+)\??.*/):void 0;let o=n&&n.length>0?n[1]:void 0;return o||(i=t.pathname.match(/(page:)([a-zA-Z\-_0-9]+)\??.*/),o=null!=i&&3==i.length?i[2]:void 0),o}getVideoType(t){return N(t.pathname)}}([],["content_scripts/hbo_max/hbo_max_content_bundled.js"],"hbomax",j.HBO_MAX,!1);Object.freeze(z);const $=z;const J=new class extends U{isValidUrl(t){return function(t){return t.hostname.includes(".amazon.")||t.hostname.includes(".primevideo.")}(t)}getVideoId(t){const e=t.pathname.split("ref")[0].match(/^.*\/([a-z\-0-9.A-Z]+)(\?|\/ref)?.*/);return null!=e&&e.length>0?e[1]:void 0}}([],["content_scripts/amazon/amazon_content_bundled.js"],"amazon",j.AMAZON,!1);Object.freeze(J);const X=J;const q=new class extends U{isValidUrl(t){return function(t){return t.hostname.includes(".youtube.")}(t)}getVideoId(t){if(t.href.includes("watch?")||t.href.includes("/shorts/")){const e=/(youtu.*be.*)\/(watch\?v=|embed\/|v|shorts|)(.*?((?=[&#?])|$))/gm.exec(t.href);return null!=e&&e.length>3&&e[3]?e[3]:void 0}return"browsing"}}([],["content_scripts/youtube/youtube_content_bundled.js"],"youtube",j.YOUTUBE,!1);Object.freeze(q);const Z=q;class Y{constructor(t,e){var s;this.id=e,this.videoId,this.url=t;const i=[G,B,V,$,X,Z];for(const e of i)if(e.isValidUrl(this.url)){this.streamingService=e,this.serviceName=e.name,this.videoId=e.getVideoId(t);break}this.sessionIdFromUrl=null!==(s=function(t,e,s){const i="?"+t.split("?")[s];if(void 0===i)return;const n=e.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&"),o=new RegExp("[?|&]"+n+"=([^&]*)(&|$)").exec(i);return null===o||o.length<2?void 0:decodeURIComponent(o[1])}(this.url.href,"npSessionId",1))&&void 0!==s?s:void 0}urlWithSessionId(t){return this.streamingService?this.streamingService.urlWithSessionId(t):void 0}}const K=4500;class Q{constructor(){this.v=new Map}p(){let t="";for(let e=0;e<16;e+=1)t+="0123456789abcdef"[Math.floor(16*Math.random())];return t}executeCallback(t,e){const s=this.v.get(t);s&&(s(e),this.v.delete(t))}addCallback(t){let e=this.p();for(;this.v.has(e);)e=this.p();return this.v.set(e,t),e}}var tt=s(187);var et=s(58);const st="undefined"!=typeof self?self:"undefined"!=typeof window?window:Function("return this")();function it(t){const e=t.xdomain;try{if("undefined"!=typeof XMLHttpRequest&&(!e||et))return new XMLHttpRequest}catch(t){}if(!e)try{return new(st[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(t){}}function nt(t,...e){return e.reduce(((e,s)=>(t.hasOwnProperty(s)&&(e[s]=t[s]),e)),{})}const ot=setTimeout,rt=clearTimeout;function ct(t,e){e.useNativeTimers?(t.setTimeoutFn=ot.bind(st),t.clearTimeoutFn=rt.bind(st)):(t.setTimeoutFn=setTimeout.bind(st),t.clearTimeoutFn=clearTimeout.bind(st))}var ht=s(63);const at=Object.create(null);at.open="0",at.close="1",at.ping="2",at.pong="3",at.message="4",at.upgrade="5",at.noop="6";const lt=Object.create(null);Object.keys(at).forEach((t=>{lt[at[t]]=t}));const ut={type:"error",data:"parser error"},dt="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===Object.prototype.toString.call(Blob),ft="function"==typeof ArrayBuffer,vt=(t,e)=>{const s=new FileReader;return s.onload=function(){const t=s.result.split(",")[1];e("b"+t)},s.readAsDataURL(t)},pt=({type:t,data:e},s,i)=>{return dt&&e instanceof Blob?s?i(e):vt(e,i):ft&&(e instanceof ArrayBuffer||(n=e,"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(n):n&&n.buffer instanceof ArrayBuffer))?s?i(e):vt(new Blob([e]),i):i(at[t]+(e||""));var n};for(var gt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",mt="undefined"==typeof Uint8Array?[]:new Uint8Array(256),yt=0;yt<gt.length;yt++)mt[gt.charCodeAt(yt)]=yt;const wt="function"==typeof ArrayBuffer,bt=(t,e)=>{if(wt){const s=function(t){var e,s,i,n,o,r=.75*t.length,c=t.length,h=0;"="===t[t.length-1]&&(r--,"="===t[t.length-2]&&r--);var a=new ArrayBuffer(r),l=new Uint8Array(a);for(e=0;e<c;e+=4)s=mt[t.charCodeAt(e)],i=mt[t.charCodeAt(e+1)],n=mt[t.charCodeAt(e+2)],o=mt[t.charCodeAt(e+3)],l[h++]=s<<2|i>>4,l[h++]=(15&i)<<4|n>>2,l[h++]=(3&n)<<6|63&o;return a}(t);return _t(s,e)}return{base64:!0,data:t}},_t=(t,e)=>"blob"===e&&t instanceof ArrayBuffer?new Blob([t]):t,kt=(t,e)=>{if("string"!=typeof t)return{type:"message",data:_t(t,e)};const s=t.charAt(0);if("b"===s)return{type:"message",data:bt(t.substring(1),e)};return lt[s]?t.length>1?{type:lt[s],data:t.substring(1)}:{type:lt[s]}:ut},St=String.fromCharCode(30);class Tt extends ht.Q{constructor(t){super(),this.writable=!1,ct(this,t),this.opts=t,this.query=t.query,this.readyState="",this.socket=t.socket}onError(t,e){const s=new Error(t);return s.type="TransportError",s.description=e,super.emit("error",s),this}open(){return"closed"!==this.readyState&&""!==this.readyState||(this.readyState="opening",this.doOpen()),this}close(){return"opening"!==this.readyState&&"open"!==this.readyState||(this.doClose(),this.onClose()),this}send(t){"open"===this.readyState&&this.write(t)}onOpen(){this.readyState="open",this.writable=!0,super.emit("open")}onData(t){const e=kt(t,this.socket.binaryType);this.onPacket(e)}onPacket(t){super.emit("packet",t)}onClose(){this.readyState="closed",super.emit("close")}}var Ct=s(281),It=s(830);class At extends Tt{constructor(){super(...arguments),this.polling=!1}get name(){return"polling"}doOpen(){this.poll()}pause(t){this.readyState="pausing";const e=()=>{this.readyState="paused",t()};if(this.polling||!this.writable){let t=0;this.polling&&(t++,this.once("pollComplete",(function(){--t||e()}))),this.writable||(t++,this.once("drain",(function(){--t||e()})))}else e()}poll(){this.polling=!0,this.doPoll(),this.emit("poll")}onData(t){((t,e)=>{const s=t.split(St),i=[];for(let t=0;t<s.length;t++){const n=kt(s[t],e);if(i.push(n),"error"===n.type)break}return i})(t,this.socket.binaryType).forEach((t=>{if("opening"===this.readyState&&"open"===t.type&&this.onOpen(),"close"===t.type)return this.onClose(),!1;this.onPacket(t)})),"closed"!==this.readyState&&(this.polling=!1,this.emit("pollComplete"),"open"===this.readyState&&this.poll())}doClose(){const t=()=>{this.write([{type:"close"}])};"open"===this.readyState?t():this.once("open",t)}write(t){this.writable=!1,((t,e)=>{const s=t.length,i=new Array(s);let n=0;t.forEach(((t,o)=>{pt(t,!1,(t=>{i[o]=t,++n===s&&e(i.join(St))}))}))})(t,(t=>{this.doWrite(t,(()=>{this.writable=!0,this.emit("drain")}))}))}uri(){let t=this.query||{};const e=this.opts.secure?"https":"http";let s="";!1!==this.opts.timestampRequests&&(t[this.opts.timestampParam]=Ct()),this.supportsBinary||t.sid||(t.b64=1),this.opts.port&&("https"===e&&443!==Number(this.opts.port)||"http"===e&&80!==Number(this.opts.port))&&(s=":"+this.opts.port);const i=It.encode(t);return e+"://"+(-1!==this.opts.hostname.indexOf(":")?"["+this.opts.hostname+"]":this.opts.hostname)+s+this.opts.path+(i.length?"?"+i:"")}}function Et(){}const xt=null!=new it({xdomain:!1}).responseType;class Pt extends ht.Q{constructor(t,e){super(),ct(this,e),this.opts=e,this.method=e.method||"GET",this.uri=t,this.async=!1!==e.async,this.data=void 0!==e.data?e.data:null,this.create()}create(){const t=nt(this.opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");t.xdomain=!!this.opts.xd,t.xscheme=!!this.opts.xs;const e=this.xhr=new it(t);try{e.open(this.method,this.uri,this.async);try{if(this.opts.extraHeaders){e.setDisableHeaderCheck&&e.setDisableHeaderCheck(!0);for(let t in this.opts.extraHeaders)this.opts.extraHeaders.hasOwnProperty(t)&&e.setRequestHeader(t,this.opts.extraHeaders[t])}}catch(t){}if("POST"===this.method)try{e.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(t){}try{e.setRequestHeader("Accept","*/*")}catch(t){}"withCredentials"in e&&(e.withCredentials=this.opts.withCredentials),this.opts.requestTimeout&&(e.timeout=this.opts.requestTimeout),e.onreadystatechange=()=>{4===e.readyState&&(200===e.status||1223===e.status?this.onLoad():this.setTimeoutFn((()=>{this.onError("number"==typeof e.status?e.status:0)}),0))},e.send(this.data)}catch(t){return void this.setTimeoutFn((()=>{this.onError(t)}),0)}"undefined"!=typeof document&&(this.index=Pt.requestsCount++,Pt.requests[this.index]=this)}onSuccess(){this.emit("success"),this.cleanup()}onData(t){this.emit("data",t),this.onSuccess()}onError(t){this.emit("error",t),this.cleanup(!0)}cleanup(t){if(void 0!==this.xhr&&null!==this.xhr){if(this.xhr.onreadystatechange=Et,t)try{this.xhr.abort()}catch(t){}"undefined"!=typeof document&&delete Pt.requests[this.index],this.xhr=null}}onLoad(){const t=this.xhr.responseText;null!==t&&this.onData(t)}abort(){this.cleanup()}}if(Pt.requestsCount=0,Pt.requests={},"undefined"!=typeof document)if("function"==typeof attachEvent)attachEvent("onunload",Dt);else if("function"==typeof addEventListener){addEventListener("onpagehide"in st?"pagehide":"unload",Dt,!1)}function Dt(){for(let t in Pt.requests)Pt.requests.hasOwnProperty(t)&&Pt.requests[t].abort()}const Ot="function"==typeof Promise&&"function"==typeof Promise.resolve?t=>Promise.resolve().then(t):(t,e)=>e(t,0),jt=st.WebSocket||st.MozWebSocket,Mt="undefined"!=typeof navigator&&"string"==typeof navigator.product&&"reactnative"===navigator.product.toLowerCase();class Ut extends Tt{constructor(t){super(t),this.supportsBinary=!t.forceBase64}get name(){return"websocket"}doOpen(){if(!this.check())return;const t=this.uri(),e=this.opts.protocols,s=Mt?{}:nt(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(s.headers=this.opts.extraHeaders);try{this.ws=Mt?new jt(t,e,s):e?new jt(t,e):new jt(t)}catch(t){return this.emit("error",t)}this.ws.binaryType=this.socket.binaryType||"arraybuffer",this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws.g.unref(),this.onOpen()},this.ws.onclose=this.onClose.bind(this),this.ws.onmessage=t=>this.onData(t.data),this.ws.onerror=t=>this.onError("websocket error",t)}write(t){this.writable=!1;for(let e=0;e<t.length;e++){const s=t[e],i=e===t.length-1;pt(s,this.supportsBinary,(t=>{try{this.ws.send(t)}catch(t){}i&&Ot((()=>{this.writable=!0,this.emit("drain")}),this.setTimeoutFn)}))}}doClose(){void 0!==this.ws&&(this.ws.close(),this.ws=null)}uri(){let t=this.query||{};const e=this.opts.secure?"wss":"ws";let s="";this.opts.port&&("wss"===e&&443!==Number(this.opts.port)||"ws"===e&&80!==Number(this.opts.port))&&(s=":"+this.opts.port),this.opts.timestampRequests&&(t[this.opts.timestampParam]=Ct()),this.supportsBinary||(t.b64=1);const i=It.encode(t);return e+"://"+(-1!==this.opts.hostname.indexOf(":")?"["+this.opts.hostname+"]":this.opts.hostname)+s+this.opts.path+(i.length?"?"+i:"")}check(){return!(!jt||"m"in jt&&this.name===Ut.prototype.name)}}const Rt={websocket:Ut,polling:class extends At{constructor(t){if(super(t),"undefined"!=typeof location){const e="https:"===location.protocol;let s=location.port;s||(s=e?"443":"80"),this.xd="undefined"!=typeof location&&t.hostname!==location.hostname||s!==t.port,this.xs=t.secure!==e}const e=t&&t.forceBase64;this.supportsBinary=xt&&!e}request(t={}){return Object.assign(t,{xd:this.xd,xs:this.xs},this.opts),new Pt(this.uri(),t)}doWrite(t,e){const s=this.request({method:"POST",data:t});s.on("success",e),s.on("error",(t=>{this.onError("xhr post error",t)}))}doPoll(){const t=this.request();t.on("data",this.onData.bind(this)),t.on("error",(t=>{this.onError("xhr poll error",t)})),this.pollXhr=t}}};class Nt extends ht.Q{constructor(t,e={}){super(),t&&"object"==typeof t&&(e=t,t=null),t?(t=tt(t),e.hostname=t.host,e.secure="https"===t.protocol||"wss"===t.protocol,e.port=t.port,t.query&&(e.query=t.query)):e.host&&(e.hostname=tt(e.host).host),ct(this,e),this.secure=null!=e.secure?e.secure:"undefined"!=typeof location&&"https:"===location.protocol,e.hostname&&!e.port&&(e.port=this.secure?"443":"80"),this.hostname=e.hostname||("undefined"!=typeof location?location.hostname:"localhost"),this.port=e.port||("undefined"!=typeof location&&location.port?location.port:this.secure?"443":"80"),this.transports=e.transports||["polling","websocket"],this.readyState="",this.writeBuffer=[],this.prevBufferLen=0,this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!0},e),this.opts.path=this.opts.path.replace(/\/$/,"")+"/","string"==typeof this.opts.query&&(this.opts.query=It.decode(this.opts.query)),this.id=null,this.upgrades=null,this.pingInterval=null,this.pingTimeout=null,this.pingTimeoutTimer=null,"function"==typeof addEventListener&&(this.opts.closeOnBeforeunload&&addEventListener("beforeunload",(()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())}),!1),"localhost"!==this.hostname&&(this.offlineEventListener=()=>{this.onClose("transport close")},addEventListener("offline",this.offlineEventListener,!1))),this.open()}createTransport(t){const e=function(t){const e={};for(let s in t)t.hasOwnProperty(s)&&(e[s]=t[s]);return e}(this.opts.query);e.EIO=4,e.transport=t,this.id&&(e.sid=this.id);const s=Object.assign({},this.opts.transportOptions[t],this.opts,{query:e,socket:this,hostname:this.hostname,secure:this.secure,port:this.port});return new Rt[t](s)}open(){let t;if(this.opts.rememberUpgrade&&Nt.priorWebsocketSuccess&&-1!==this.transports.indexOf("websocket"))t="websocket";else{if(0===this.transports.length)return void this.setTimeoutFn((()=>{this.emitReserved("error","No transports available")}),0);t=this.transports[0]}this.readyState="opening";try{t=this.createTransport(t)}catch(t){return this.transports.shift(),void this.open()}t.open(),this.setTransport(t)}setTransport(t){this.transport&&this.transport.removeAllListeners(),this.transport=t,t.on("drain",this.onDrain.bind(this)).on("packet",this.onPacket.bind(this)).on("error",this.onError.bind(this)).on("close",(()=>{this.onClose("transport close")}))}probe(t){let e=this.createTransport(t),s=!1;Nt.priorWebsocketSuccess=!1;const i=()=>{s||(e.send([{type:"ping",data:"probe"}]),e.once("packet",(t=>{if(!s)if("pong"===t.type&&"probe"===t.data){if(this.upgrading=!0,this.emitReserved("upgrading",e),!e)return;Nt.priorWebsocketSuccess="websocket"===e.name,this.transport.pause((()=>{s||"closed"!==this.readyState&&(a(),this.setTransport(e),e.send([{type:"upgrade"}]),this.emitReserved("upgrade",e),e=null,this.upgrading=!1,this.flush())}))}else{const t=new Error("probe error");t.transport=e.name,this.emitReserved("upgradeError",t)}})))};function n(){s||(s=!0,a(),e.close(),e=null)}const o=t=>{const s=new Error("probe error: "+t);s.transport=e.name,n(),this.emitReserved("upgradeError",s)};function r(){o("transport closed")}function c(){o("socket closed")}function h(t){e&&t.name!==e.name&&n()}const a=()=>{e.removeListener("open",i),e.removeListener("error",o),e.removeListener("close",r),this.off("close",c),this.off("upgrading",h)};e.once("open",i),e.once("error",o),e.once("close",r),this.once("close",c),this.once("upgrading",h),e.open()}onOpen(){if(this.readyState="open",Nt.priorWebsocketSuccess="websocket"===this.transport.name,this.emitReserved("open"),this.flush(),"open"===this.readyState&&this.opts.upgrade&&this.transport.pause){let t=0;const e=this.upgrades.length;for(;t<e;t++)this.probe(this.upgrades[t])}}onPacket(t){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState)switch(this.emitReserved("packet",t),this.emitReserved("heartbeat"),t.type){case"open":this.onHandshake(JSON.parse(t.data));break;case"ping":this.resetPingTimeout(),this.sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong");break;case"error":const e=new Error("server error");e.code=t.data,this.onError(e);break;case"message":this.emitReserved("data",t.data),this.emitReserved("message",t.data)}}onHandshake(t){this.emitReserved("handshake",t),this.id=t.sid,this.transport.query.sid=t.sid,this.upgrades=this.filterUpgrades(t.upgrades),this.pingInterval=t.pingInterval,this.pingTimeout=t.pingTimeout,this.onOpen(),"closed"!==this.readyState&&this.resetPingTimeout()}resetPingTimeout(){this.clearTimeoutFn(this.pingTimeoutTimer),this.pingTimeoutTimer=this.setTimeoutFn((()=>{this.onClose("ping timeout")}),this.pingInterval+this.pingTimeout),this.opts.autoUnref&&this.pingTimeoutTimer.unref()}onDrain(){this.writeBuffer.splice(0,this.prevBufferLen),this.prevBufferLen=0,0===this.writeBuffer.length?this.emitReserved("drain"):this.flush()}flush(){"closed"!==this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length&&(this.transport.send(this.writeBuffer),this.prevBufferLen=this.writeBuffer.length,this.emitReserved("flush"))}write(t,e,s){return this.sendPacket("message",t,e,s),this}send(t,e,s){return this.sendPacket("message",t,e,s),this}sendPacket(t,e,s,i){if("function"==typeof e&&(i=e,e=void 0),"function"==typeof s&&(i=s,s=null),"closing"===this.readyState||"closed"===this.readyState)return;(s=s||{}).compress=!1!==s.compress;const n={type:t,data:e,options:s};this.emitReserved("packetCreate",n),this.writeBuffer.push(n),i&&this.once("flush",i),this.flush()}close(){const t=()=>{this.onClose("forced close"),this.transport.close()},e=()=>{this.off("upgrade",e),this.off("upgradeError",e),t()},s=()=>{this.once("upgrade",e),this.once("upgradeError",e)};return"opening"!==this.readyState&&"open"!==this.readyState||(this.readyState="closing",this.writeBuffer.length?this.once("drain",(()=>{this.upgrading?s():t()})):this.upgrading?s():t()),this}onError(t){Nt.priorWebsocketSuccess=!1,this.emitReserved("error",t),this.onClose("transport error",t)}onClose(t,e){"opening"!==this.readyState&&"open"!==this.readyState&&"closing"!==this.readyState||(this.clearTimeoutFn(this.pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),"function"==typeof removeEventListener&&removeEventListener("offline",this.offlineEventListener,!1),this.readyState="closed",this.id=null,this.emitReserved("close",t,e),this.writeBuffer=[],this.prevBufferLen=0)}filterUpgrades(t){const e=[];let s=0;const i=t.length;for(;s<i;s++)~this.transports.indexOf(t[s])&&e.push(t[s]);return e}}Nt.protocol=4;Nt.protocol;const Wt="function"==typeof ArrayBuffer,Ft=Object.prototype.toString,Gt="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===Ft.call(Blob),Lt="function"==typeof File||"undefined"!=typeof File&&"[object FileConstructor]"===Ft.call(File);function Bt(t){return Wt&&(t instanceof ArrayBuffer||(t=>"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(t):t.buffer instanceof ArrayBuffer)(t))||Gt&&t instanceof Blob||Lt&&t instanceof File}function Ht(t,e){if(!t||"object"!=typeof t)return!1;if(Array.isArray(t)){for(let e=0,s=t.length;e<s;e++)if(Ht(t[e]))return!0;return!1}if(Bt(t))return!0;if(t.toJSON&&"function"==typeof t.toJSON&&1===arguments.length)return Ht(t.toJSON(),!0);for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e)&&Ht(t[e]))return!0;return!1}function Vt(t){const e=[],s=t.data,i=t;return i.data=zt(s,e),i.attachments=e.length,{packet:i,buffers:e}}function zt(t,e){if(!t)return t;if(Bt(t)){const s={_:!0,num:e.length};return e.push(t),s}if(Array.isArray(t)){const s=new Array(t.length);for(let i=0;i<t.length;i++)s[i]=zt(t[i],e);return s}if("object"==typeof t&&!(t instanceof Date)){const s={};for(const i in t)Object.prototype.hasOwnProperty.call(t,i)&&(s[i]=zt(t[i],e));return s}return t}function $t(t,e){return t.data=Jt(t.data,e),t.attachments=void 0,t}function Jt(t,e){if(!t)return t;if(t&&t._)return e[t.num];if(Array.isArray(t))for(let s=0;s<t.length;s++)t[s]=Jt(t[s],e);else if("object"==typeof t)for(const s in t)Object.prototype.hasOwnProperty.call(t,s)&&(t[s]=Jt(t[s],e));return t}const Xt=5;var qt;!function(t){t[t.CONNECT=0]="CONNECT",t[t.DISCONNECT=1]="DISCONNECT",t[t.EVENT=2]="EVENT",t[t.ACK=3]="ACK",t[t.CONNECT_ERROR=4]="CONNECT_ERROR",t[t.BINARY_EVENT=5]="BINARY_EVENT",t[t.BINARY_ACK=6]="BINARY_ACK"}(qt||(qt={}));class Zt{encode(t){return t.type!==qt.EVENT&&t.type!==qt.ACK||!Ht(t)?[this.encodeAsString(t)]:(t.type=t.type===qt.EVENT?qt.BINARY_EVENT:qt.BINARY_ACK,this.encodeAsBinary(t))}encodeAsString(t){let e=""+t.type;return t.type!==qt.BINARY_EVENT&&t.type!==qt.BINARY_ACK||(e+=t.attachments+"-"),t.nsp&&"/"!==t.nsp&&(e+=t.nsp+","),null!=t.id&&(e+=t.id),null!=t.data&&(e+=JSON.stringify(t.data)),e}encodeAsBinary(t){const e=Vt(t),s=this.encodeAsString(e.packet),i=e.buffers;return i.unshift(s),i}}class Yt extends ht.Q{constructor(){super()}add(t){let e;if("string"==typeof t)e=this.decodeString(t),e.type===qt.BINARY_EVENT||e.type===qt.BINARY_ACK?(this.reconstructor=new Kt(e),0===e.attachments&&super.emitReserved("decoded",e)):super.emitReserved("decoded",e);else{if(!Bt(t)&&!t.base64)throw new Error("Unknown type: "+t);if(!this.reconstructor)throw new Error("got binary data when not reconstructing a packet");e=this.reconstructor.takeBinaryData(t),e&&(this.reconstructor=null,super.emitReserved("decoded",e))}}decodeString(t){let e=0;const s={type:Number(t.charAt(0))};if(void 0===qt[s.type])throw new Error("unknown packet type "+s.type);if(s.type===qt.BINARY_EVENT||s.type===qt.BINARY_ACK){const i=e+1;for(;"-"!==t.charAt(++e)&&e!=t.length;);const n=t.substring(i,e);if(n!=Number(n)||"-"!==t.charAt(e))throw new Error("Illegal attachments");s.attachments=Number(n)}if("/"===t.charAt(e+1)){const i=e+1;for(;++e;){if(","===t.charAt(e))break;if(e===t.length)break}s.nsp=t.substring(i,e)}else s.nsp="/";const i=t.charAt(e+1);if(""!==i&&Number(i)==i){const i=e+1;for(;++e;){const s=t.charAt(e);if(null==s||Number(s)!=s){--e;break}if(e===t.length)break}s.id=Number(t.substring(i,e+1))}if(t.charAt(++e)){const i=function(t){try{return JSON.parse(t)}catch(t){return!1}}(t.substr(e));if(!Yt.isPayloadValid(s.type,i))throw new Error("invalid payload");s.data=i}return s}static isPayloadValid(t,e){switch(t){case qt.CONNECT:return"object"==typeof e;case qt.DISCONNECT:return void 0===e;case qt.CONNECT_ERROR:return"string"==typeof e||"object"==typeof e;case qt.EVENT:case qt.BINARY_EVENT:return Array.isArray(e)&&e.length>0;case qt.ACK:case qt.BINARY_ACK:return Array.isArray(e)}}destroy(){this.reconstructor&&this.reconstructor.finishedReconstruction()}}class Kt{constructor(t){this.packet=t,this.buffers=[],this.reconPack=t}takeBinaryData(t){if(this.buffers.push(t),this.buffers.length===this.reconPack.attachments){const t=$t(this.reconPack,this.buffers);return this.finishedReconstruction(),t}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}function Qt(t,e,s){return t.on(e,s),function(){t.off(e,s)}}const te=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class ee extends ht.Q{constructor(t,e,s){super(),this.connected=!1,this.disconnected=!0,this.receiveBuffer=[],this.sendBuffer=[],this.ids=0,this.acks={},this.flags={},this.io=t,this.nsp=e,s&&s.auth&&(this.auth=s.auth),this.io.k&&this.open()}subEvents(){if(this.subs)return;const t=this.io;this.subs=[Qt(t,"open",this.onopen.bind(this)),Qt(t,"packet",this.onpacket.bind(this)),Qt(t,"error",this.onerror.bind(this)),Qt(t,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected||(this.subEvents(),this.io.S||this.io.open(),"open"===this.io.T&&this.onopen()),this}open(){return this.connect()}send(...t){return t.unshift("message"),this.emit.apply(this,t),this}emit(t,...e){if(te.hasOwnProperty(t))throw new Error('"'+t+'" is a reserved event name');e.unshift(t);const s={type:qt.EVENT,data:e,options:{}};if(s.options.compress=!1!==this.flags.compress,"function"==typeof e[e.length-1]){const t=this.ids++,i=e.pop();this.C(t,i),s.id=t}const i=this.io.engine&&this.io.engine.transport&&this.io.engine.transport.writable;return this.flags.volatile&&(!i||!this.connected)||(this.connected?this.packet(s):this.sendBuffer.push(s)),this.flags={},this}C(t,e){const s=this.flags.timeout;if(void 0===s)return void(this.acks[t]=e);const i=this.io.setTimeoutFn((()=>{delete this.acks[t];for(let e=0;e<this.sendBuffer.length;e++)this.sendBuffer[e].id===t&&this.sendBuffer.splice(e,1);e.call(this,new Error("operation has timed out"))}),s);this.acks[t]=(...t)=>{this.io.clearTimeoutFn(i),e.apply(this,[null,...t])}}packet(t){t.nsp=this.nsp,this.io.I(t)}onopen(){"function"==typeof this.auth?this.auth((t=>{this.packet({type:qt.CONNECT,data:t})})):this.packet({type:qt.CONNECT,data:this.auth})}onerror(t){this.connected||this.emitReserved("connect_error",t)}onclose(t){this.connected=!1,this.disconnected=!0,delete this.id,this.emitReserved("disconnect",t)}onpacket(t){if(t.nsp===this.nsp)switch(t.type){case qt.CONNECT:if(t.data&&t.data.sid){const e=t.data.sid;this.onconnect(e)}else this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case qt.EVENT:case qt.BINARY_EVENT:this.onevent(t);break;case qt.ACK:case qt.BINARY_ACK:this.onack(t);break;case qt.DISCONNECT:this.ondisconnect();break;case qt.CONNECT_ERROR:this.destroy();const e=new Error(t.data.message);e.data=t.data.data,this.emitReserved("connect_error",e)}}onevent(t){const e=t.data||[];null!=t.id&&e.push(this.ack(t.id)),this.connected?this.emitEvent(e):this.receiveBuffer.push(Object.freeze(e))}emitEvent(t){if(this.A&&this.A.length){const e=this.A.slice();for(const s of e)s.apply(this,t)}super.emit.apply(this,t)}ack(t){const e=this;let s=!1;return function(...i){s||(s=!0,e.packet({type:qt.ACK,id:t,data:i}))}}onack(t){const e=this.acks[t.id];"function"==typeof e&&(e.apply(this,t.data),delete this.acks[t.id])}onconnect(t){this.id=t,this.connected=!0,this.disconnected=!1,this.emitBuffered(),this.emitReserved("connect")}emitBuffered(){this.receiveBuffer.forEach((t=>this.emitEvent(t))),this.receiveBuffer=[],this.sendBuffer.forEach((t=>this.packet(t))),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach((t=>t())),this.subs=void 0),this.io.P(this)}disconnect(){return this.connected&&this.packet({type:qt.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(t){return this.flags.compress=t,this}get volatile(){return this.flags.volatile=!0,this}timeout(t){return this.flags.timeout=t,this}onAny(t){return this.A=this.A||[],this.A.push(t),this}prependAny(t){return this.A=this.A||[],this.A.unshift(t),this}offAny(t){if(!this.A)return this;if(t){const e=this.A;for(let s=0;s<e.length;s++)if(t===e[s])return e.splice(s,1),this}else this.A=[];return this}listenersAny(){return this.A||[]}}var se=s(10);class ie extends ht.Q{constructor(e,s){var i;super(),this.nsps={},this.subs=[],e&&"object"==typeof e&&(s=e,e=void 0),(s=s||{}).path=s.path||"/socket.io",this.opts=s,ct(this,s),this.reconnection(!1!==s.reconnection),this.reconnectionAttempts(s.reconnectionAttempts||1/0),this.reconnectionDelay(s.reconnectionDelay||1e3),this.reconnectionDelayMax(s.reconnectionDelayMax||5e3),this.randomizationFactor(null!==(i=s.randomizationFactor)&&void 0!==i?i:.5),this.backoff=new se({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(null==s.timeout?2e4:s.timeout),this.T="closed",this.uri=e;const n=s.parser||t;this.encoder=new n.Encoder,this.decoder=new n.Decoder,this.k=!1!==s.autoConnect,this.k&&this.open()}reconnection(t){return arguments.length?(this.D=!!t,this):this.D}reconnectionAttempts(t){return void 0===t?this.O:(this.O=t,this)}reconnectionDelay(t){var e;return void 0===t?this.j:(this.j=t,null===(e=this.backoff)||void 0===e||e.setMin(t),this)}randomizationFactor(t){var e;return void 0===t?this.M:(this.M=t,null===(e=this.backoff)||void 0===e||e.setJitter(t),this)}reconnectionDelayMax(t){var e;return void 0===t?this.U:(this.U=t,null===(e=this.backoff)||void 0===e||e.setMax(t),this)}timeout(t){return arguments.length?(this.R=t,this):this.R}maybeReconnectOnOpen(){!this.S&&this.D&&0===this.backoff.attempts&&this.reconnect()}open(t){if(~this.T.indexOf("open"))return this;this.engine=new Nt(this.uri,this.opts);const e=this.engine,s=this;this.T="opening",this.skipReconnect=!1;const i=Qt(e,"open",(function(){s.onopen(),t&&t()})),n=Qt(e,"error",(e=>{s.cleanup(),s.T="closed",this.emitReserved("error",e),t?t(e):s.maybeReconnectOnOpen()}));if(!1!==this.R){const t=this.R;0===t&&i();const s=this.setTimeoutFn((()=>{i(),e.close(),e.emit("error",new Error("timeout"))}),t);this.opts.autoUnref&&s.unref(),this.subs.push((function(){clearTimeout(s)}))}return this.subs.push(i),this.subs.push(n),this}connect(t){return this.open(t)}onopen(){this.cleanup(),this.T="open",this.emitReserved("open");const t=this.engine;this.subs.push(Qt(t,"ping",this.onping.bind(this)),Qt(t,"data",this.ondata.bind(this)),Qt(t,"error",this.onerror.bind(this)),Qt(t,"close",this.onclose.bind(this)),Qt(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(t){this.decoder.add(t)}ondecoded(t){this.emitReserved("packet",t)}onerror(t){this.emitReserved("error",t)}socket(t,e){let s=this.nsps[t];return s||(s=new ee(this,t,e),this.nsps[t]=s),s}P(t){const e=Object.keys(this.nsps);for(const t of e){if(this.nsps[t].active)return}this.N()}I(t){const e=this.encoder.encode(t);for(let s=0;s<e.length;s++)this.engine.write(e[s],t.options)}cleanup(){this.subs.forEach((t=>t())),this.subs.length=0,this.decoder.destroy()}N(){this.skipReconnect=!0,this.S=!1,this.onclose("forced close"),this.engine&&this.engine.close()}disconnect(){return this.N()}onclose(t){this.cleanup(),this.backoff.reset(),this.T="closed",this.emitReserved("close",t),this.D&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this.S||this.skipReconnect)return this;const t=this;if(this.backoff.attempts>=this.O)this.backoff.reset(),this.emitReserved("reconnect_failed"),this.S=!1;else{const e=this.backoff.duration();this.S=!0;const s=this.setTimeoutFn((()=>{t.skipReconnect||(this.emitReserved("reconnect_attempt",t.backoff.attempts),t.skipReconnect||t.open((e=>{e?(t.S=!1,t.reconnect(),this.emitReserved("reconnect_error",e)):t.onreconnect()})))}),e);this.opts.autoUnref&&s.unref(),this.subs.push((function(){clearTimeout(s)}))}}onreconnect(){const t=this.backoff.attempts;this.S=!1,this.backoff.reset(),this.emitReserved("reconnect",t)}}const ne={};function oe(t,e){"object"==typeof t&&(e=t,t=void 0);const s=function(t,e="",s){let i=t;s=s||"undefined"!=typeof location&&location,null==t&&(t=s.protocol+"//"+s.host),"string"==typeof t&&("/"===t.charAt(0)&&(t="/"===t.charAt(1)?s.protocol+t:s.host+t),/^(https?|wss?):\/\//.test(t)||(t=void 0!==s?s.protocol+"//"+t:"https://"+t),i=tt(t)),i.port||(/^(http|ws)$/.test(i.protocol)?i.port="80":/^(http|ws)s$/.test(i.protocol)&&(i.port="443")),i.path=i.path||"/";const n=-1!==i.host.indexOf(":")?"["+i.host+"]":i.host;return i.id=i.protocol+"://"+n+":"+i.port+e,i.href=i.protocol+"://"+n+(s&&s.port===i.port?"":":"+i.port),i}(t,(e=e||{}).path||"/socket.io"),i=s.source,n=s.id,o=s.path,r=ne[n]&&o in ne[n].nsps;let c;return e.forceNew||e["force new connection"]||!1===e.multiplex||r?c=new ie(i,e):(ne[n]||(ne[n]=new ie(i,e)),c=ne[n]),s.query&&!e.query&&(e.query=s.queryKey),c.socket(s.path,e)}Object.assign(oe,{Manager:ie,Socket:ee,io:oe,connect:oe});var re,ce,he,ae,le=function(t,e,s,i){return new(s||(s=Promise))((function(n,o){function r(t){try{h(i.next(t))}catch(t){o(t)}}function c(t){try{h(i.throw(t))}catch(t){o(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(r,c)}h((i=i.apply(t,e||[])).next())}))};class ue{constructor(t,e,s){this.W=0,this.F=!1,this.G=!0,this.L=e,this.B=t,this.H=0,this.V=new Q,this.$=new WebSocket(this.B),this.J(),this.X=setTimeout(this.q.bind(this),5e3),this.Y=s}getId(){return this.K}getType(){return void 0!==this.$?"uws":"socket.io"}getTransport(){var t;return void 0!==this.$?"websocket":null===(t=this.tt)||void 0===t?void 0:t.io.engine.transport.name}getSocketStartTime(){return this.et}st(){return{id:this.getId(),type:this.getType(),transport:this.getTransport(),start_time_ms:this.getSocketStartTime()}}q(){var t,e;null===(t=this.tt)||void 0===t||t.disconnect(),null===(e=this.$)||void 0===e||e.close(K),console.log("Connect timed out, switching servers");const s={name:"socket_error",action:{description:this.F?"socket.io":"uws failed to connect in time",reason:"connect timed out"},socket_session:this.st()};qe.logEventForTabId(s,this.Y),this.it()}loadSessionData(t,e){this.nt=t.sessionId,this.L.loadSessionData(t,e)}clearSessionData(){this.nt=void 0,this.L.clearSessionData()}getCurrentSessionData(){return this.L.getSessionData()}J(){this.$&&(this.$.onmessage=this.ot.bind(this),this.$.onclose=this.rt.bind(this),this.$.onerror=this.ct.bind(this),this.$.onopen=this.ht.bind(this),this.lt=setInterval(this.ut.bind(this),45e3))}dt(){this.tt&&(this.tt.on("connect",(()=>{this.ht()})),this.tt.on("connect_error",(t=>{console.log(`connect_error due to ${t.message}`),e(t);const s={name:"socket_error",action:{description:t.message,reason:"socket reported error."},socket_session:this.st()};qe.logEventForTabId(s,this.Y)})),this.tt.on("disconnect",(t=>{this.ft(),e("Socket io disconnect"),this.lt&&clearInterval(this.lt),e("Websocket lost connection: "+t);const s={name:"socket_close",action:{description:"socket.io socket closed",reason:t},socket_session:this.st()};if(qe.logEventForTabId(s,this.Y),"io client disconnect"!==t)this.it();else if(this.nt){const t={name:"party_disconnect",action:{reason:"party disconnected manually."},socket_session:this.st()};qe.logEventForTabId(t,this.Y)}})),this.tt.on("message",(t=>{var e;if("ping"===t)null===(e=this.tt)||void 0===e||e.emit("pong");else{const e=JSON.parse(t);this.vt(e)}})))}ut(){var t;1==(null===(t=this.$)||void 0===t?void 0:t.readyState)&&this.$.send(JSON.stringify({type:"ping"}))}ht(){this.et=Date.now(),this.ft();const t={name:"socket_open",socket_session:this.st()};if(qe.logEventForTabId(t,this.Y),this.gt){clearTimeout(this.gt),this.L.onReconnect();const t={name:"party_reconnect",action:{description:"party reconnected using "+(this.F?"socket.io":"uws")+" after "+this.H+" attempts.",reason:"party reconnected."},socket_session:this.st()};qe.logEventForTabId(t,this.Y)}this.yt()}yt(){this.gt&&clearTimeout(this.gt),this.gt=void 0,this.H=0}ft(){console.log("Clearing connect timeout"),this.X&&clearTimeout(this.X)}rt(t){this.ft();const s={name:"socket_close",action:{description:"uws socket closed",reason:String(t.code)},socket_session:this.st()};if(qe.logEventForTabId(s,this.Y),t.code!==K){if(e("Websocket lost connection"),1007===t.code){const e={sessionId:this.nt,eventType:"socket-close-"+t.code};qe.logOldEventAsync(e)}this.it()}else{if(this.nt){const t={name:"party_disconnect",action:{reason:"party disconnected manually."},socket_session:this.st()};qe.logEventForTabId(t,this.Y)}e("Websocket connection closed manually")}}wt(){return 1e3*Math.pow(2,this.H)}it(){if(this.G)if(this.bt(),this.H++,this.H>10)this.L.onReconnectFailed();else{let t=this.wt();e("Recreating socket with delay: "+t),void 0===this.K&&this.H<=2&&(t=500),this.gt=setTimeout(this._t.bind(this),t)}}_t(){try{this.W>=3||this.H>1?this.F=!this.F:this.F=!1,this.F?this.$=void 0:this.tt=void 0;const t={name:"socket_reconnect_attempt",action:{description:"attempting to reconnect using "+(this.F?"socket.io":"uws"),reason:"reconnecting after socket disconnect"},socket_session:this.st()};qe.logEventForTabId(t,this.Y),this.F?(this.tt=oe("https://socketio.teleparty.com",{reconnection:!1,withCredentials:!0}),this.dt()):(this.$=new WebSocket(this.B),this.J()),this.ft(),this.X=setTimeout(this.q.bind(this),5e3)}catch(t){console.warn("Failed to recreate socket: "+(10-this.H)+" attempts remaining")}}bt(){this.W+=1}ct(t){e("WebSocket error observed:",t);const s={name:"socket_error",action:{description:"uws socket error",reason:"socket reported error."},socket_session:this.st()};qe.logEventForTabId(s,this.Y)}ot(t){try{const e=JSON.parse(t.data);this.vt(e)}catch(t){e("An error occured while parsing a message from the server")}}vt(t){"userId"===t.type?this.kt(t.data.userId):t.callbackId?this.V.executeCallback(t.callbackId,t.data):this.L.onMessage(t)}kt(t){e("User id:  "+t),null==this.K&&(this.K=t,this.L.setUserId(t))}teardown(){var t,e;this.G=!1;try{null===(t=this.$)||void 0===t||t.close(K),null===(e=this.tt)||void 0===e||e.disconnect()}catch(t){}this.gt&&clearTimeout(this.gt),this.lt&&clearInterval(this.lt)}sendMessage(t,e,s){var i,n;let o="null";s&&(o=this.V.addCallback(s));const r=this.St(t,e,o),c=JSON.stringify(r);this.F?null===(i=this.tt)||void 0===i||i.send(c):null===(n=this.$)||void 0===n||n.send(c)}St(t,e,s){return{type:t,data:e,callbackId:s}}getUserIdAsync(){var t;return le(this,void 0,void 0,(function*(){e("user Id promise called: "),this.gt&&(this.yt(),this._t());try{return yield function(t,e,s=250){return function(){const i=(new Date).getTime(),n=function(){return t()?Promise.resolve():null!==e&&(new Date).getTime()-i>e?Promise.reject(new Error("delayUntil timed out: "+t)):W(s)().then(n)};return n()}}((()=>null!=this.K),2e4)(),null!==(t=this.K)&&void 0!==t?t:""}catch(t){const e={name:"connection_error",action:{description:t,reason:"failed to get user id"},socket_session:this.st()};qe.logEventForTabId(e,this.Y);const s={sessionId:this.nt,eventType:"connection-fail"};throw qe.logOldEventAsync(s),new Error("Could not get a response from the socket in time. Please refresh the page and try again.")}}))}}class de extends x{constructor(t,e,s){super(t,e,s),this.type=s}}!function(t){t.INIT_CHAT="initChat",t.ON_MESSAGE="onMessage",t.ON_BUFFER="onBuffer",t.ON_TYPING="onTyping",t.ON_WATCHING_ADS="onWatchingAds",t.UPDATE_SETTINGS="updateSettings",t.ON_REACTION="onReaction",t.ON_GIF="onGif",t.ON_LOG_EVENT="onLogEvent"}(re||(re={}));class fe extends de{constructor(t,e,s){super(t,e,re.ON_MESSAGE),this.data=s}}class ve extends de{constructor(t,e,s){super(t,e,re.ON_REACTION),this.data=s}}class pe extends de{constructor(t,e,s){super(t,e,re.UPDATE_SETTINGS),this.data=s}}class ge extends de{constructor(t,e,s){super(t,e,re.ON_BUFFER),this.data=s}}class me extends de{constructor(t,e,s){super(t,e,re.ON_TYPING),this.data=s}}class ye extends de{constructor(t,e,s){super(t,e,re.ON_WATCHING_ADS),this.data=s}}class we extends x{constructor(t,e,s){super(t,e,s),this.type=s}}!function(t){t.UPDATE_SESSION="updateSession",t.NEXT_EPISODE="nextEpisode",t.REBOOT_SESSION="rebootSession",t.GET_SERVER_TIME="getServerTime",t.RELOAD_PARTY="reloadParty"}(ce||(ce={}));class be extends we{constructor(t,e,s){super(t,e,ce.UPDATE_SESSION),this.data=s}}class _e{loadSessionData(t,e){this.Tt=t,this.Tt&&(this.Tt.userSettings=e,this.Tt.messages||(this.Tt.messages=[]))}get sessionData(){return this.Tt}set sessionData(t){this.Tt=t}}class ke extends we{constructor(t,e,s){super(t,e,ce.NEXT_EPISODE),this.data=s}}class Se extends we{constructor(t,e,s){super(t,e,ce.REBOOT_SESSION),this.data=s}}class Te extends de{constructor(t,e,s){super(t,e,re.ON_GIF),this.data=s}}class Ce{constructor(t){this.Y=t,this.Ct=new _e}setUserId(t){this.K=t}onMessage(t){switch(t.type){case O.SEND_MESSAGE:this.It(t);break;case O.SET_BUFFERING_PRESENCE:this.At(t);break;case O.SET_TYPING_PRESENCE:this.Et(t);break;case O.SET_ADS_PRESENCE:this.xt(t);break;case O.UPDATE_SETTINGS_MESSAGE:this.Pt(t);break;case O.UPDATE_SESSION:this.Dt(t);break;case O.JUMP_TO_NEXT_EPISODE:this.Ot(t);break;case O.SEND_REACTION:this.jt(t);break;case O.SEND_GIF:this.Mt(t)}}clearSessionData(){this.Ct.sessionData=void 0}getSessionData(){return this.Ct.sessionData}loadSessionData(t,e){this.Ct.loadSessionData(t,e)}setDataManager(t){this.Ct=t}onConnect(){e("Connected to server")}onReconnectFailed(){const t=new we(_,k,ce.RELOAD_PARTY);o.removeSocketForTabId(this.Y),E.sendMessageToTabAsync(t,this.Y)}onReconnect(){if(this.Ct.sessionData){const t=o.getSocketForTabId(this.Y);null==t||t.sendMessage(O.REBOOT_MESSAGE,this.Ct.sessionData,(t=>{if(!t||t.errorMessage)t&&console.log(t.errorMessage),this.onReconnectFailed();else{const e=new Se(_,k,t);E.sendMessageToTabAsync(e,this.Y).then((t=>{t||this.onReconnectFailed()}))}}))}}It(t){var e;const s=new fe(_,k,t.data);E.sendMessageToTabAsync(s,this.Y),null===(e=this.Ct.sessionData)||void 0===e||e.messages.push(s.data)}At(t){const e=new ge(_,k,t.data);e.data.usersBuffering=e.data.usersBuffering.filter((t=>t!=this.K)),E.sendMessageToTabAsync(e,this.Y)}Et(t){const e=new me(_,k,t.data);e.data.usersTyping=e.data.usersTyping.filter((t=>t!=this.K)),E.sendMessageToTabAsync(e,this.Y)}jt(t){const e=new ve(_,k,t.data);E.sendMessageToTabAsync(e,this.Y)}Mt(t){var e;const s=new Te(_,k,t.data);E.sendMessageToTabAsync(s,this.Y),null===(e=this.Ct.sessionData)||void 0===e||e.messages.push(s.data)}xt(t){const e=new ye(_,k,t.data);console.log(e),e.data.usersWatchingAds=e.data.usersWatchingAds.filter((t=>t!=this.K)),E.sendMessageToTabAsync(e,this.Y)}Pt(t){const e=new pe(_,k,t.data);E.sendMessageToTabAsync(e,this.Y),this.Ct.sessionData&&this.Ct.sessionData.permId==e.data.permId&&(this.Ct.sessionData.userSettings,e.data.userSettings)}Dt(t){const e=new be(_,k,t.data);E.sendMessageToTabAsync(e,this.Y),this.Ct.sessionData&&(this.Ct.sessionData.state=e.data.state,this.Ct.sessionData.lastKnownTime=e.data.lastKnownTime,this.Ct.sessionData.lastKnownTimeUpdatedAt=e.data.lastKnownTimeUpdatedAt)}Ot(t){const e=new ke(_,k,t.data);E.sendMessageToTabAsync(e,this.Y),this.Ct.sessionData&&(this.Ct.sessionData.videoId=e.data.videoId)}}class Ie{constructor(t){this.Y=t}createSocketForTab(){const t=new Ce(this.Y),s=new ue(C,t,this.Y);return e("Created Socket with url: "+C),s}}!function(t){t.CREATE_SESSION="createSession",t.RE_INJECT="reInject",t.GET_INIT_DATA="getInitData",t.IS_CONTENT_SCRIPT_READY="isContentScriptReady",t.SET_CHAT_VISIBLE="setChatVisible",t.DISCONNECT="teardown",t.CLOSE_POPUP="closePopup"}(he||(he={})),function(t){t.BROADCAST="brodadcast",t.BROADCAST_NEXT_EPISODE="broadcastNextEpisode",t.SEND_MESSAGE="sendMessage",t.CONTENT_SCRIPT_READY="contentScriptReady",t.CONTENT_SCRIPT_ERROR="contentScriptError",t.TEARDOWN="teardown",t.GET_SESSION_DATA="getSessionData",t.SET_TYPING="setTyping",t.SET_BUFFERING="setBuffering",t.SET_WATCHING_ADS="setWatchingAds",t.BROADCAST_USER_SETTINGS="brodadcastUserSettings",t.SEND_REACTION="sendReaction",t.SEND_GIF="sendGIF"}(ae||(ae={}));var Ae=function(t,e,s,i){return new(s||(s=Promise))((function(n,o){function r(t){try{h(i.next(t))}catch(t){o(t)}}function c(t){try{h(i.throw(t))}catch(t){o(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(r,c)}h((i=i.apply(t,e||[])).next())}))};const Ee=new class{getRedirectDataForTabAsync(t){return Ae(this,void 0,void 0,(function*(){const e=(yield l.getItemsAsync([I])).redirectDataMap,s=this.Ut(t);if(e&&e[s]){const t=e[s];if(this.Rt(t))return t}}))}deleteRedirectDataForTabAsync(t){return Ae(this,void 0,void 0,(function*(){const e=(yield l.getItemsAsync([I])).redirectDataMap,s=this.Ut(t);e&&e[s]&&delete e[s],yield m.setItemsAsync({[I]:e})}))}Ut(t){return t}storeRedirectDataForTabAsync(t,e){return Ae(this,void 0,void 0,(function*(){const s=this.Ut(e);let i=yield l.getItemsAsync([I]);i[s]=t,i=this.Nt(i),yield m.setItemsAsync({[I]:i})}))}Nt(t){return function(t,e){const s={};let i;for(i in t)t.hasOwnProperty(i)&&e(t[i])&&(s[i]=t[i]);return s}(t,this.Rt)}Rt(t){const e=t.date;return void 0!==e&&"number"==typeof e&&e<=Date.now()&&Date.now()-e<108e5}};Object.freeze(Ee);const xe=Ee;class Pe{constructor(){e("Message forwarder"),this.Wt()}Ft(t,s,i){if(t.target===_){if(t.type==ae.BROADCAST){const e=t;return this.Gt(O.UPDATE_SESSION,e.data,s,i),!0}if(t.type==ae.SEND_MESSAGE){const e=t;return this.Gt(O.SEND_MESSAGE,e.data,s,i),!0}if(t.type==ae.SET_TYPING){const e=t;return this.Gt(O.SET_TYPING_PRESENCE,e.data,s,i),!0}if(t.type==ae.SET_BUFFERING){const e=t;return this.Gt(O.SET_BUFFERING_PRESENCE,e.data,s,i),!0}if(t.type==ae.SET_WATCHING_ADS){const e=t;return this.Gt(O.SET_ADS_PRESENCE,e.data,s,i),!0}if(t.type===ae.BROADCAST_USER_SETTINGS){const e=t;return this.Gt(O.BROADCAST_USER_SETTINGS,e.data,s,i),!0}if(t.type===ae.BROADCAST_NEXT_EPISODE){const e=t;return this.Gt(O.NEXT_EPISODE_MESSAGE,e.data,s,i),!0}if(t.type===ce.GET_SERVER_TIME)return this.Gt(O.GET_SERVER_TIME,{},s,i),!0;if(t.type==ae.SEND_REACTION){const e=t;return this.Gt(O.SEND_REACTION,e.data,s,i),!0}if(t.type==ae.SEND_GIF){const e=t;return this.Gt(O.SEND_GIF,e.data,s,i),!0}if(t.type==r.REBOOT){const s=t,n=o.getSocketForTabId(s.data.tabId);return null==n||n.sendMessage(O.REBOOT_MESSAGE,s.data.sessionData,i),e("Attempted to reboot session"),!0}}return!1}Gt(t,e,s,i){const n=this.Lt(s);null==n||n.sendMessage(t,e,i)}Lt(t){var e;const s=null===(e=t.tab)||void 0===e?void 0:e.id;return s?o.getSocketForTabId(s):void 0}Wt(){E.addListener(this.Ft.bind(this))}}class De extends x{constructor(t,e,s){super(t,e,s),this.type=s}}class Oe extends De{constructor(t,e){super(t,e,he.CLOSE_POPUP)}}class je extends De{constructor(t,e){super(t,e,he.IS_CONTENT_SCRIPT_READY)}}var Me,Ue=new Uint8Array(16);function Re(){if(!Me&&!(Me="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Me(Ue)}const Ne=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;const We=function(t){return"string"==typeof t&&Ne.test(t)};for(var Fe=[],Ge=0;Ge<256;++Ge)Fe.push((Ge+256).toString(16).substr(1));const Le=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=(Fe[t[e+0]]+Fe[t[e+1]]+Fe[t[e+2]]+Fe[t[e+3]]+"-"+Fe[t[e+4]]+Fe[t[e+5]]+"-"+Fe[t[e+6]]+Fe[t[e+7]]+"-"+Fe[t[e+8]]+Fe[t[e+9]]+"-"+Fe[t[e+10]]+Fe[t[e+11]]+Fe[t[e+12]]+Fe[t[e+13]]+Fe[t[e+14]]+Fe[t[e+15]]).toLowerCase();if(!We(s))throw TypeError("Stringified UUID is invalid");return s};const Be=function(t,e,s){var i=(t=t||{}).random||(t.rng||Re)();if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,e){s=s||0;for(var n=0;n<16;++n)e[s+n]=i[n];return e}return Le(i)};function He(){try{return Be()}catch(t){return""}}const Ve={$6:["*://*/*"]};var ze=function(t,e,s,i){return new(s||(s=Promise))((function(n,o){function r(t){try{h(i.next(t))}catch(t){o(t)}}function c(t){try{h(i.throw(t))}catch(t){o(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(r,c)}h((i=i.apply(t,e||[])).next())}))};class $e{constructor(){this.Bt=null,this.Ht(),this.Vt(),this.zt=0,this.$t=0,this.Jt=0,this.Xt=0,this.qt=He(),this.Zt=He(),this.Yt=Date.now(),this.Kt=0,this.Qt=0,this.te=new Map}setEventWindow(t){this.Bt=t}closeEventWindow(){this.Bt&&(this.Bt.close(),this.Bt=null)}eventPostMessage(t,e){var s;null===(s=this.Bt)||void 0===s||s.postMessage(t,e)}addAliveTab(t,e){this.te.set(t,e)}removeAliveTab(t){const e=this.te.get(t);e&&clearTimeout(e),this.te.delete(t)}checkAliveTab(t){return this.te.has(t)}clearTimeout(t){const e=this.te.get(t);e&&clearTimeout(e)}getVideoSessionData(){return{id:this.Zt,start_time_ms:this.zt,heartbeat_duration_ms:Math.min(this.Xt,$e.MAX_HEARTBEAT),total_duration_ms:this.Jt}}resetVideoSession(){this.Zt=He(),this.zt=Date.now(),this.$t=Date.now(),this.Jt=0,this.Qt=0}pauseHeartBeat(){this.Xt=0}resumeHeartBeat(){this.$t=Date.now(),this.Xt=0,this.Qt=0}heartBeatProc(){this.Xt=0===this.$t?Date.now()-this.zt:Date.now()-this.$t,this.Jt+=this.Xt,this.$t=Date.now(),this.Qt=0}incrementAppSessionEventNumber(){this.Kt++}getAppSession(){return{id:this.qt,start_time_ms:this.Yt,event_number:this.Kt}}ee(){chrome.runtime.reload()}Ht(){chrome.tabs.onUpdated.addListener(this.se.bind(this)),chrome.runtime.onInstalled.addListener(this.ie.bind(this)),chrome.storage.onChanged.addListener(((t,e)=>{console.log("storage change: "+JSON.stringify(t)+" for "+JSON.stringify(e))})),chrome.runtime.onUpdateAvailable.addListener(this.ee.bind(this))}ie(t){if("install"==t.reason){console.log("This is a first install!");const t=chrome.runtime.getManifest().version;qe.ne({name:"install",action:{description:"install extension for the first time version "+t}}),qe.logOldEventAsync({eventType:"install"}),chrome.tabs.create({url:"https://redirect.teleparty.com/get-started"})}else if("update"==t.reason){const e=chrome.runtime.getManifest().version;console.log("Updated from "+t.previousVersion+" to "+e+"!"),qe.logOldEventAsync({eventType:"update-"+e});Math.random()<.05&&"3.9.5"===e&&chrome.permissions.contains({origins:Ve.$6},(t=>{qe.ne({name:"granted_permissions",action:{description:t?"true":"false"}})}))}}oe(t){return 16===t.length||36===t.length}re(){const t=navigator.userAgent.toLowerCase().indexOf("edg")>-1?"edge":"chrome";console.log("browser: "+t);const e="?browser="+t,s=new XMLHttpRequest;s.onreadystatechange=()=>{if(s.readyState==XMLHttpRequest.DONE){const t=s.responseText,e=new Date;this.oe(t)&&(chrome.storage.local.set({userId:t,recentlyUpdated:!0,recentlyUpdated3:!0,date:e.toString()},(function(){console.log("Settings saved")})),chrome.runtime.setUninstallURL("https://www.teleparty.com/uninstall?userId="+t+"&browser=chrome&version="+encodeURIComponent(chrome.runtime.getManifest().version)))}},s.open("GET","https://data3.netflixparty.com/create-userId"+e,!0),s.send(null)}Vt(){try{chrome.storage.local.get(null,(t=>{t.userId&&b.isUserIdValid(t.userId)?chrome.runtime.setUninstallURL("https://www.teleparty.com/uninstall?userId="+t.userId+"&browser=chrome&version="+encodeURIComponent(chrome.runtime.getManifest().version)):(console.log("userId undefined/invalid in local storage -> now setting"),this.re())}))}catch(t){console.log("user auth error");const e={name:"error",action:{description:"user auth error",reason:t}};qe.ne(e)}}se(t,e,s){if("loading"===e.status&&qe.ce(s),"complete"==e.status){const t=s.url;if(t&&s.id){const e=new URL(t).hostname,i=new Y(new URL(t),s.id),n=i.streamingService;T.some((t=>e.includes(t)))&&chrome.tabs.executeScript(s.id,{file:"ci_bundled.js"}),n&&this.initContentScriptsAsync(i),(new URL(t).hostname.includes("redirect.teleparty")||new URL(t).hostname.includes("localhost"))&&chrome.tabs.executeScript(s.id,{file:"redirect_injected_bundled.js",allFrames:!0})}else if(chrome.runtime.lastError)return}}initContentScriptsAsync(t){return ze(this,void 0,void 0,(function*(){if(t.streamingService){const e=t.streamingService;yield new Promise((e=>{chrome.tabs.executeScript(t.id,{file:"lib/tp_libraries_min.js"},e)})),yield new Promise((e=>{chrome.tabs.executeScript(t.id,{code:`\n                        if (!window.teleparty) {\n                            window.teleparty = { tabId: ${t.id} }\n                        }\n                    `},e)})),yield Promise.all(e.contentScripts.map((e=>new Promise((s=>{chrome.tabs.executeScript(t.id,{file:e},(()=>{s()}))})))));const s=new je(_,k);yield E.sendMessageToTabAsync(s,t.id)}}))}}$e.MAX_HEARTBEAT=8e4;var Je=function(t,e,s,i){return new(s||(s=Promise))((function(n,o){function r(t){try{h(i.next(t))}catch(t){o(t)}}function c(t){try{h(i.throw(t))}catch(t){o(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(r,c)}h((i=i.apply(t,e||[])).next())}))};const Xe=new class{constructor(){this.he=new Map,this.ae=[],this.Ct=new $e,this.Wt(),e("Service Background")}le(){this.Ct.closeEventWindow()}ue(){this.le();const t=window.open("https://redirect.teleparty.com/event-logger","Teleparty Logger","width=600,height=530,status=0,scrollbars=0,menubar=0");t&&this.Ct.setEventWindow(t)}Ft(t,s,i){var n,o,c,h,a,l,u,d,f,v,p,g,m,y;if(t.target===_){if(t.type==he.CREATE_SESSION){const r=t;e("Got create Session Message");const c=r.data;return 0===c.extensionTabData.id&&(c.extensionTabData.id=null!==(o=null===(n=s.tab)||void 0===n?void 0:n.id)&&void 0!==o?o:0),this.de(c).then(i).catch(this.fe(i,s.tab)),!0}if(t.type==ae.GET_SESSION_DATA){const e=t;return this.ve(e.data,s).then(i).catch(this.fe(i,s.tab)),!0}if(t.type==r.TEARDOWN){const e=t;return this.pe(e,s).then(i),!0}if(t.type==r.LOG_EVENT){const e=t.data;if("eventType"in e)this.logOldEventAsync(e);else{let t;this.he.forEach((e=>{var i;e.chatTabId===(null===(i=s.tab)||void 0===i?void 0:i.id)&&(t=e.videoTabId)})),t?this.ge(t).then((t=>{this.ne(e,t)})):this.ne(e,s.tab)}return i(),!0}if(t.type==r.LOG_EXPERIMENT){const e=t;return this.logExperimentAsync(e.data),i(),!0}if(t.type==he.RE_INJECT){const n=t;e("Got Re Inject Message");const o=n.data;return 0===o.extensionTabData.id&&(o.extensionTabData.id=null!==(h=null===(c=s.tab)||void 0===c?void 0:c.id)&&void 0!==h?h:0),this.me(o).then(i).catch(this.fe(i,s.tab)),!0}if(t.type==r.STAY_ALIVE){const e=t.data.tabId;return this.ye(e),i(),!0}if(t.type==r.LOAD_CHAT_WINDOW){const t=null!==(l=null===(a=s.tab)||void 0===a?void 0:a.id)&&void 0!==l?l:0,e=null!==(d=null===(u=s.tab)||void 0===u?void 0:u.windowId)&&void 0!==d?d:0;return this.we(t,e).then(i),!0}if(t.type==r.RESET_CHAT_WINDOW){const t=null!==(v=null===(f=s.tab)||void 0===f?void 0:f.id)&&void 0!==v?v:0;let e;return this.he.forEach((s=>{s.chatTabId!=t&&s.videoTabId!=t||(e=s)})),e&&this.be(e).then(i),!0}if(t.type==r.HIDE_CHAT_WINDOW){const t=null!==(g=null===(p=s.tab)||void 0===p?void 0:p.id)&&void 0!==g?g:0;let e;return this.he.forEach((s=>{s.chatTabId!=t&&s.videoTabId!=t||(e=s)})),e&&this._e(e).then(i),!0}}else if(t.target==k){const e=null!==(y=null===(m=s.tab)||void 0===m?void 0:m.id)&&void 0!==y?y:0;let n;return this.he.forEach((t=>{t.chatTabId==e&&(n=t.videoTabId)})),n&&(t.tabId=e,E.sendMessageToTabAsync(t,n).then(i)),!0}}ye(t){const e=setTimeout((()=>Je(this,void 0,void 0,(function*(){this.Ct.removeAliveTab(t),yield this.ke(t)}))),6e4);this.Ct.addAliveTab(t,e)}me(t){return Je(this,void 0,void 0,(function*(){const e=t.extensionTabData;yield this.Ct.initContentScriptsAsync(e)}))}Se(){var t;return Je(this,void 0,void 0,(function*(){const e=yield l.getItemsAsync(["extensionUses"]),s=null!==(t=e.extensionUses)&&void 0!==t?t:0;yield m.setItemsAsync({extensionUses:s+1})}))}logExperimentAsync(t){return Je(this,void 0,void 0,(function*(){try{const e={permId:yield this.Te(),event:t.eventType,name:t.experimentName,version:t.experimentVersion};console.log("event: "+JSON.stringify(e));const s=new XMLHttpRequest;s.open("POST","https://data3.netflixparty.com/log-experiment"),s.setRequestHeader("Content-Type","application/json"),s.send(JSON.stringify(e))}catch(t){console.log("log event error : "+t)}}))}Ce(){let t="";return navigator.userAgent.includes("Firefox/")?t=`Firefox v${navigator.userAgent.split("Firefox/")[1]}`:navigator.userAgent.includes("Edg/")?t=`Edg v${navigator.userAgent.split("Edg/")[1]}`:navigator.userAgent.includes("Chrome/")&&(t=`Chrome v${navigator.userAgent.split("Chrome/")[1]}`),t}Ie(){let t="";return-1!=navigator.userAgent.indexOf("Windows NT 10.0")&&(t="Windows 10"),-1!=navigator.userAgent.indexOf("Windows NT 6.3")&&(t="Windows 8.1"),-1!=navigator.userAgent.indexOf("Windows NT 6.2")&&(t="Windows 8"),-1!=navigator.userAgent.indexOf("Windows NT 6.1")&&(t="Windows 7"),-1!=navigator.userAgent.indexOf("Windows NT 6.0")&&(t="Windows Vista"),-1!=navigator.userAgent.indexOf("Windows NT 5.1")&&(t="Windows XP"),-1!=navigator.userAgent.indexOf("Windows NT 5.0")&&(t="Windows 2000"),-1!=navigator.userAgent.indexOf("Mac")&&(t="Mac/iOS"),-1!=navigator.userAgent.indexOf("X11")&&(t="UNIX"),-1!=navigator.userAgent.indexOf("Linux")&&(t="Linux"),t}Ae(t){const e=o.getSocketForTabId(t);return{id:null==e?void 0:e.getId(),transport:null==e?void 0:e.getTransport(),type:null==e?void 0:e.getType(),start_time_ms:null==e?void 0:e.getSocketStartTime()}}Ee(t,e){var s,i,n,r,c,h;return Je(this,void 0,void 0,(function*(){const a=Object.assign({},t),l=o.getSocketForTabId(null!==(s=e.id)&&void 0!==s?s:0);if(l){const t=l.getCurrentSessionData();if(t&&t.sessionId){const e={id:null==t?void 0:t.sessionId,start_time_ms:null==t?void 0:t.created_at};a.party_session=e}const s=this.Ae(null!==(i=e.id)&&void 0!==i?i:0);s.id&&(a.socket_session=s);const o=this.Ct.getVideoSessionData();try{const t=yield this.xe(null!==(n=e.id)&&void 0!==n?n:0),s=t.videoState;a.page&&(a.page.is_adblock_enabled=t.is_adblock_enabled,a.page.is_chat_visible=t.is_chat_visible,a.page.is_player_fullscreen=t.is_player_fullscreen),o.status=s,o.video_ts_ms=t.video_ts_ms,o.party_ts_ms=t.party_ts_ms,t.content.service=null===(r=t.content.service)||void 0===r?void 0:r.toLowerCase(),t.content.episode_name=null===(c=t.content.episode_name)||void 0===c?void 0:c.toLowerCase(),t.content.name=null===(h=t.content.name)||void 0===h?void 0:h.toLowerCase(),a.screen=t.screen,a.content=t.content}catch(t){console.log(t)}(a.party_session&&a.party_session.id||a.name.startsWith("video_"))&&(a.video_session=o)}return a}))}Pe(){var t;const e=null===(t=window.navigator.userAgentData)||void 0===t?void 0:t.platform;return{name:"chrome",version:this.Ce(),type:"browser",manufacturer:e,model:"",os_name:this.Ie(),os_version:""}}De(t,e,s){const i=this.Pe(),n=this.Ct.getAppSession(),o=Date.now(),r={name:"chrome_ext",version:chrome.runtime.getManifest().version},c=Object.assign({},e);return c.app||(c.app=r),c.app_session||(c.app_session=n),c.device=i,c.client_timestamp_ms=o,null==c.page&&(c.page=t),c.user=s,c}ge(t){return Je(this,void 0,void 0,(function*(){return new Promise(((e,s)=>{try{chrome.tabs.get(t,(t=>{chrome.runtime.lastError?s(chrome.runtime.lastError):e(t)}))}catch(t){s(t)}}))}))}Oe(t,e){return Je(this,void 0,void 0,(function*(){return new Promise(((s,i)=>{try{chrome.tabs.update(t,{url:e},(()=>{s()}))}catch(t){i(t)}}))}))}je(t){return Je(this,void 0,void 0,(function*(){const e=t.chatTabId;chrome.tabs.move(e,{index:-1,windowId:t.videoWindow.id},(e=>Je(this,void 0,void 0,(function*(){var s;yield this.be(t),chrome.tabs.update(null!==(s=e.id)&&void 0!==s?s:0,{active:!0})}))))}))}ce(t){return Je(this,void 0,void 0,(function*(){let e;this.he.forEach((s=>{s.chatTabId===(null==t?void 0:t.id)&&(e=s)})),e&&t.url!==A&&this.je(e)}))}logEventForTabId(t,e){return Je(this,void 0,void 0,(function*(){const s=yield this.ge(e);return this.ne(t,s)}))}ne(t,e){var s,i,n;return Je(this,void 0,void 0,(function*(){if(t.name.includes("error")){if(this.ae=this.ae.filter((t=>t>Date.now()-6e4)),this.ae.length>=15)return void console.log("Error rate limited");this.ae.push(Date.now())}let o=Object.assign({},t);try{const t=yield b.getValidatedChromeStorageDataAsync(),r=yield this.Te(),c=["video_heartbeat"];this.Ct.incrementAppSessionEventNumber();const h={name:null!==(s=null==e?void 0:e.title)&&void 0!==s?s:"",url:null!==(i=null==e?void 0:e.url)&&void 0!==i?i:""},a={id:r,name:t.userNickname,is_logged_in:!1};o=this.De(h,o,a),o.component&&(o.component.type=null===(n=o.component.type)||void 0===n?void 0:n.toLowerCase()),"video_start"===o.name&&this.Ct.resetVideoSession(),"video_pause"===o.name&&this.Ct.pauseHeartBeat(),"video_resume"===o.name&&this.Ct.resumeHeartBeat(),c.includes(o.name)&&this.Ct.heartBeatProc(),e&&e.id&&(o=yield this.Ee(o,e))}catch(t){console.log("log event error : "+t)}this.Me(o)}))}Ue(t){return["socket_open","socket_close","socket_error","party_reconnect","party_disconnect"].includes(t.name)}Me(t){try{const e="https://metis.teleparty.com/v1/record",s=new XMLHttpRequest;s.open("PUT",e),s.setRequestHeader("Content-Type","application/json"),s.send(JSON.stringify(t))}catch(t){console.error(t)}}openLogPage(){0}logOldEventAsync(t){return Je(this,void 0,void 0,(function*(){try{const e={userId:yield this.Te(),eventType:t.eventType,sessionId:t.sessionId};console.log("event: "+JSON.stringify(e));const s=new XMLHttpRequest;s.open("POST","https://data3.netflixparty.com/log-event"),s.setRequestHeader("Content-Type","application/json"),s.send(JSON.stringify(e))}catch(t){console.log("log event error : "+t)}}))}pe(t,e){var s;return Je(this,void 0,void 0,(function*(){if(e.tab&&e.tab.id){const i=e.tab.id;t.sender=_,t.target=k,yield E.sendMessageToTabAsync(t,i),yield this.ke(i);const n=new Oe(_,"Popup");E.u(n);const o=this.he.get(i);o&&((null===(s=null==o?void 0:o.chatWindow)||void 0===s?void 0:s.id)&&chrome.windows.remove(o.chatWindow.id),this.he.delete(i))}}))}Re(t){return Je(this,void 0,void 0,(function*(){const e=yield b.getValidatedChromeStorageDataAsync(),s=(yield this.Ne(t)).getCurrentSessionData();if(s){const i={sessionCallbackData:s,storageData:e,isCreate:!1,showReviewMessage:this.We(e)},n=new D(_,k,i);yield this.Fe(t,n);const o={name:"video_fix",action:{description:"video session was restored after next video error"}};this.logEventForTabId(o,t)}}))}ve(t,e){return Je(this,void 0,void 0,(function*(){if(!(e.tab&&e.tab.id&&e.url))throw new Error("Invalid Request");{const s=e.url,i=e.tab.id;if(this.Ct.checkAliveTab(i))return this.Ct.removeAliveTab(i),void this.Re(i);const n=new Y(new URL(s),i);yield this.ke(i);const o=yield this.Ge(i);let r,c,h;if(o?(r=o.sessionId,c=o.videoType,h=o.serviceDomain,yield this.Le(i)):r=n.sessionIdFromUrl,r){R(new URL(s))&&(n.videoId=t.videoId);const e={extensionTab:n,sessionId:r,videoType:c,serviceDomain:h};return yield this.Be(e)}}}))}He(t){var e,s;return{userIcon:null!==(e=t.userIcon)&&void 0!==e?e:"",userNickname:null!==(s=t.userNickname)&&void 0!==s?s:""}}Be(t){var e;return Je(this,void 0,void 0,(function*(){const s=t.extensionTab,i=s.streamingService,n=yield this.Ne(s.id);n.clearSessionData();const o=yield b.getValidatedChromeStorageDataAsync(),r=yield n.getUserIdAsync(),c=o.userId?o.userId:r;o.userId||(yield this.Ve(r),o.userId=r);const h=this.He(o),a=null!==(e=null==i?void 0:i.serverName)&&void 0!==e?e:"",l={videoId:s.videoId,sessionId:t.sessionId,videoService:a,permId:c,userSettings:h},u=yield new Promise((t=>{n.sendMessage(O.JOIN_SESSION,l,(e=>{t(e)}))})),d=Object.assign(Object.assign({},u),{userId:r,permId:c,videoService:a,videoType:t.videoType,serviceDomain:t.serviceDomain,userSettings:h}),f=yield this.ze(u,t.extensionTab.id,o,a);return n.loadSessionData(d,h),f}))}de(t){var e;return Je(this,void 0,void 0,(function*(){const s=t.extensionTabData,i=s.streamingService,n=yield this.xe(s.id),o=yield this.Ne(s.id);o.clearSessionData();const r=yield b.getValidatedChromeStorageDataAsync(),c=yield o.getUserIdAsync(),h=r.userId?r.userId:c;r.userId||(yield this.Ve(c),r.userId=c);const a=this.He(r),l=null!==(e=null==i?void 0:i.serverName)&&void 0!==e?e:"",u={controlLock:t.createSettings.controlLock,videoId:n.videoId,videoDuration:n.videoDuration,videoType:n.videoType,serviceDomain:n.serviceDomain,videoService:l,syncFromEnd:null==i?void 0:i.syncFromEnd,permId:h,userSettings:a},d=yield new Promise((t=>{o.sendMessage(O.CREATE_SESSION,u,(e=>{t(e)}))})),f=Object.assign(Object.assign({},d),{userId:c,permId:h,videoService:l,messages:[],created_at:Date.now(),videoType:n.videoType,serviceDomain:n.serviceDomain,userSettings:a}),v=yield this.$e(d,s.id,r,l,t.pageControls);return o.loadSessionData(f,a),v}))}Ne(t){return Je(this,void 0,void 0,(function*(){const e=o.getSocketForTabId(t);if(e)return e;{const e=yield this.Je(t);return o.setSocketForTabId(t,e),e}}))}ke(t){return Je(this,void 0,void 0,(function*(){const e=o.getSocketForTabId(t);e&&(e.teardown(),o.removeSocketForTabId(t))}))}Je(t){return Je(this,void 0,void 0,(function*(){const e=new Ie(t);return yield e.createSocketForTab()}))}xe(t){return Je(this,void 0,void 0,(function*(){const e=new P(_,k,r.GET_VIDEO_DATA),s=yield E.sendMessageToTabAsync(e,t);if(s){if(s.error)throw new Error(s.error);return s}throw new Error("Failed to connect to Script. Please refresh the page and try again")}))}Ge(t){return Je(this,void 0,void 0,(function*(){const e=xe.getRedirectDataForTabAsync(t);return xe.deleteRedirectDataForTabAsync(t),e}))}Le(t){return Je(this,void 0,void 0,(function*(){return xe.deleteRedirectDataForTabAsync(t)}))}Te(){return Je(this,void 0,void 0,(function*(){return new Promise(((t,e)=>{let s=0;const i=()=>Je(this,void 0,void 0,(function*(){s++;const n=yield b.getValidatedChromeStorageDataAsync();n.userId?t(n.userId):s<5?setTimeout(i,5e3):e("Could not get permId in time")}));i()}))}))}Ve(t){return Je(this,void 0,void 0,(function*(){e("No perm id found, using socket id"),yield m.setItemsAsync({userId:t})}))}We(t){return void 0!==t.extensionUses&&(1===t.extensionUses||t.extensionUses%5==0)&&!t.reviewClicked}$e(t,e,s,i,n){return Je(this,void 0,void 0,(function*(){if(!t||t.errorMessage)throw this.Le(e),new Error(t?t.errorMessage:"An unexpected error occured. Please refresh the page and try again.");{const o={sessionCallbackData:t,storageData:s,isCreate:!0,showReviewMessage:this.We(s)},r=new D(_,k,o);yield this.Fe(e,r);const c={eventType:"create-session-chrome"+(n?"-pc":""),sessionId:t.sessionId};this.logOldEventAsync(c);const h={name:"party_start",action:{description:i,reason:"session was created"}};return this.logEventForTabId(h,e),this.Se(),{sessionId:t.sessionId,showReviewMessage:this.We(s)}}}))}ze(t,e,s,i){return Je(this,void 0,void 0,(function*(){if(!t||t.errorMessage)throw this.Le(e),new Error(t?t.errorMessage:"An error occured while trying to join the session. Please navigate to the party url and try again.");{const n={sessionCallbackData:t,storageData:s,isCreate:!1,showReviewMessage:this.We(s)},o=new D(_,k,n);yield this.Fe(e,o);const r={eventType:"join-session-chrome",sessionId:t.sessionId};this.logOldEventAsync(r);const c={name:"party_join",action:{description:i}};return this.logEventForTabId(c,e),this.Se(),{sessionId:t.sessionId,showReviewMessage:this.We(s)}}}))}Fe(t,e,s){return Je(this,void 0,void 0,(function*(){return new Promise(((i,n)=>{let o;s&&(o=setTimeout((()=>{n(new Error("Could not get a response from the page in time. Please refresh the page and try again."))}),s)),chrome.tabs.sendMessage(t,e,(t=>{o&&clearTimeout(o),i(t)}))}))}))}Xe(t,e){return Je(this,void 0,void 0,(function*(){return new Promise(((s,i)=>{chrome.windows.update(t,e,(t=>Je(this,void 0,void 0,(function*(){chrome.runtime.lastError?i(chrome.runtime.lastError):(yield W(150)(),s(t))}))))}))}))}qe(t){return Je(this,void 0,void 0,(function*(){return new Promise(((e,s)=>{chrome.windows.create(t,(t=>{chrome.runtime.lastError||void 0===t?s(chrome.runtime.lastError):e(t)}))}))}))}Ze(t){return new Promise((e=>{chrome.windows.get(t,(t=>{chrome.runtime.lastError||void 0===t?e(!1):e(!0)}))}))}Ye(t){return new Promise(((e,s)=>{chrome.tabs.query({windowId:t},(t=>{var i;chrome.runtime.lastError?s(chrome.runtime.lastError):e(null!==(i=t[0].id)&&void 0!==i?i:0)}))}))}Ke(t){return new Promise((e=>{chrome.tabs.update(t,{active:!0},(()=>{e()}))}))}_e(t){return Je(this,void 0,void 0,(function*(){const e=t.videoWindow;yield this.Ke(t.videoTabId);let s=t.chatWindow;(yield this.Ze(s.id))&&(s=yield this.Xe(s.id,{state:"minimized",focused:!1})),yield this.Xe(e.id,{state:"maximized"}),yield this.Xe(e.id,{focused:!0,width:window.screen.width,height:window.screen.height})}))}be(t,e=0){var s;return Je(this,void 0,void 0,(function*(){let i=t.videoWindow;yield this.Ke(t.videoTabId),i=yield this.Xe(i.id,{state:"maximized"}),i=yield this.Xe(i.id,{state:"normal",width:window.screen.width-358,height:window.screen.availHeight,left:0,top:0,focused:!0});let n=t.chatWindow,r=!1;(yield this.Ze(n.id))||(n=yield this.qe({url:A,type:"popup"}),r=!0);const c=yield this.Ye(n.id);if(!r){const t=yield this.ge(c);void 0!==t.url&&t.url!==A&&(yield this.Oe(c,A))}n=yield this.Xe(n.id,{state:"normal",width:u,height:window.screen.availHeight,left:window.screen.width-u,top:0,focused:!0});const h={chatWindow:n,videoWindow:i,chatTabId:c,videoTabId:t.videoTabId};this.he.set(t.videoTabId,h);const a=o.getSocketForTabId(t.videoTabId);if(a&&o.setSocketForTabId(c,a),console.log(i.width),e<2&&window.screen.width-(null!==(s=i.width)&&void 0!==s?s:0)<50)return console.log("Retry Reset"),this.be(t,e+1)}))}we(t,e){var s;return Je(this,void 0,void 0,(function*(){const i=yield this.Xe(e,{state:"maximized"});yield this.Xe(i.id,{state:"normal",width:window.screen.width-358,height:window.screen.availHeight});const n=yield this.qe({url:A,type:"popup",state:"maximized"});if(yield this.Xe(n.id,{state:"normal",width:u,height:window.screen.availHeight,left:window.screen.width-u,top:0}),!n||!i)throw new Error("Failed to Create Party View");{const e=n.tabs&&null!==(s=n.tabs[0].id)&&void 0!==s?s:0,r={chatWindow:n,videoWindow:i,chatTabId:e,videoTabId:t};this.he.set(t,r);const c=o.getSocketForTabId(r.videoTabId);c&&o.setSocketForTabId(e,c)}}))}fe(t,e){return s=>{this.Qe(s.message,e),t({error:s.message})}}Qe(t,s,i){const n={name:"error",action:{reason:t,description:i}};this.ne(n,s),e("An error occured: "+i)}Wt(){chrome.runtime.onSuspend.addListener((()=>{o.teardown()})),chrome.tabs.onRemoved.addListener(this.ts.bind(this)),chrome.runtime.onMessage.addListener(this.Ft.bind(this)),this.es(),new Pe}ts(t){return Je(this,void 0,void 0,(function*(){try{yield this.ge(t);return}catch(t){}const s=o.getSocketForTabId(t);if(s&&!this.Ct.checkAliveTab(t)){const i={name:"tab_close",action:{description:"tab was closed with socket",source:"tabID: "+t}};this.logEventForTabId(i,t);let n=!1;this.he.forEach((e=>{(e.chatTabId===t||o.getSocketForTabId(e.videoTabId)===s)&&(n=!0)})),n||(e("Detected Tab Close: Disconnecting socket for tab: "+t),s.teardown(),o.removeSocketForTabId(t))}const i=this.he.get(t);i&&chrome.tabs.remove(i.chatTabId)}))}es(){chrome.runtime.onConnect.addListener((t=>{var s,i;const n=null===(i=null===(s=t.sender)||void 0===s?void 0:s.tab)||void 0===i?void 0:i.id;if(n){e("Connected to Content Script with Tab ID: "+n);try{t.postMessage("pong"),t.onDisconnect.addListener((()=>{console.log("Detected port disconnect: "+n),this.ts(n)}))}catch(t){}}}))}};Object.freeze(Xe);const qe=Xe;window.teleparty=Xe})()})();