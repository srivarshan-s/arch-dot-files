/*******************************************************
* Copyright (C) 2018-2022 WP Interactive Media, Inc. - All Rights Reserved
* Unauthorized copying of this file, via any medium is strictly prohibited
* Proprietary and confidential
*******************************************************/
(()=>{"use strict";const e="Failed to read chrome storage. Please refresh the page and try again";var n=function(e,n,t,o){return new(t||(t=Promise))((function(i,r){function c(e){try{a(o.next(e))}catch(e){r(e)}}function s(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var n;e.done?i(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(c,s)}a((o=o.apply(e,n||[])).next())}))};const t=new class{getItemsAsync(t){return n(this,void 0,void 0,(function*(){return new Promise(((n,o)=>{chrome.storage.local.get(t,(t=>{chrome.runtime.lastError?o(new Error(e)):n(t)}))}))}))}getAllItemsAsync(){return n(this,void 0,void 0,(function*(){return new Promise(((n,t)=>{chrome.storage.local.get(null,(o=>{chrome.runtime.lastError?t(new Error(e)):n(o)}))}))}))}};Object.freeze(t);const o=t;var i=function(e,n,t,o){return new(t||(t=Promise))((function(i,r){function c(e){try{a(o.next(e))}catch(e){r(e)}}function s(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var n;e.done?i(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(c,s)}a((o=o.apply(e,n||[])).next())}))};const r=new class{setItemsAsync(e){return i(this,void 0,void 0,(function*(){return new Promise(((n,t)=>{chrome.storage.local.set(e,(()=>{chrome.runtime.lastError?t(new Error("Failed to write to chrome storage. Please refresh the page and try again")):n()}))}))}))}};Object.freeze(r);const c=r;const s=chrome.runtime.id,a=["bpgopfmgmnojmhnhmgpfmpnookgbmkko","oocalimimngaihdkbihfgmpkcpnmlaoa","igbncjcgfkfnfgbaieiimpfkobabmkce"],u="redirectDataMap";var d=function(e,n,t,o){return new(t||(t=Promise))((function(i,r){function c(e){try{a(o.next(e))}catch(e){r(e)}}function s(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var n;e.done?i(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(c,s)}a((o=o.apply(e,n||[])).next())}))};const l=new class{getRedirectDataForTabAsync(e){return d(this,void 0,void 0,(function*(){const n=(yield o.getItemsAsync([u])).redirectDataMap,t=this.t(e);if(n&&n[t]){const e=n[t];if(this.o(e))return e}}))}deleteRedirectDataForTabAsync(e){return d(this,void 0,void 0,(function*(){const n=(yield o.getItemsAsync([u])).redirectDataMap,t=this.t(e);n&&n[t]&&delete n[t],yield c.setItemsAsync({[u]:n})}))}t(e){return e}storeRedirectDataForTabAsync(e,n){return d(this,void 0,void 0,(function*(){const t=this.t(n);let i=yield o.getItemsAsync([u]);i[t]=e,i=this.i(i),yield c.setItemsAsync({[u]:i})}))}i(e){return function(e,n){const t={};let o;for(o in e)e.hasOwnProperty(o)&&n(e[o])&&(t[o]=e[o]);return t}(e,this.o)}o(e){const n=e.date;return void 0!==n&&"number"==typeof n&&n<=Date.now()&&Date.now()-n<108e5}};Object.freeze(l);const m=l,f={$6:["*://*/*"]},h="Service_Background",v="Iframe";class y extends class{constructor(e,n,t){this.sender=e,this.target=n,this.type=t}}{constructor(e,n,t){super(e,n,t),this.type=t}}var p;!function(e){e.JOIN_SESSION="joinSession",e.GET_VIDEO_DATA="getVideoData",e.LOAD_SESSION="loadSession",e.NO_SESSION_DATA="noSessionData",e.TEARDOWN="teardown",e.ON_VIDEO_UPDATE="onVideoUpdate",e.SOCKET_LOST_CONNECTION="socketLostConnection",e.REBOOT="socketReconnect",e.LOG_EVENT="logEvent",e.LOG_EXPERIMENT="logExpirement",e.STAY_ALIVE="stayAlive",e.LOAD_CHAT_WINDOW="loadChatWindow",e.RESET_CHAT_WINDOW="resetChatWindow",e.HIDE_CHAT_WINDOW="hideChatWindow"}(p||(p={}));class w extends y{constructor(e,n,t){super(e,n,p.LOG_EVENT),this.data=t,this.sender=e,this.target=n}}var g=console.log.bind(window.console);const x=new class{addListener(e){chrome.runtime.onMessage.addListener(e)}removeListener(e){chrome.runtime.onMessage.removeListener(e)}sendMessageToTabAsync(e,n,t=2e4){return new Promise(((o,i)=>{const r=setTimeout((()=>{i()}),t);try{chrome.tabs.sendMessage(n,e,(n=>{chrome.runtime.lastError&&g(chrome.runtime.lastError.message+JSON.stringify(e)),clearTimeout(r),o(n)}))}catch(e){clearTimeout(r),i(e)}}))}u(e,n){return new Promise(((t,o)=>{let i=null;n&&(i=setTimeout((()=>{o({error:"Send Message Timeout"})}),n));try{chrome.runtime.sendMessage(s,e,(n=>{chrome.runtime.lastError&&console.log(chrome.runtime.lastError.message+JSON.stringify(e)),i&&clearTimeout(i),t(n)}))}catch(e){i&&clearTimeout(i),o(e)}}))}},b=x;class T extends y{constructor(e,n,t){super(e,n,p.LOG_EXPERIMENT),this.data=t}}var P=function(e,n,t,o){return new(t||(t=Promise))((function(i,r){function c(e){try{a(o.next(e))}catch(e){r(e)}}function s(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var n;e.done?i(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(c,s)}a((o=o.apply(e,n||[])).next())}))};console.log("Loaded");let k="new";const S="https://www.netflix.com/watch/*";let D,A;function I(e){return"https://www.tele.pe"===e.origin&&(k="old"),function(e){if(null!=a.find((n=>e.origin===`chrome-extension://${n}`)))return!0;return null!=e.origin.match(/^https:\/\/[^.]*\.(?:(?:tele\.pe)|(?:teleparty\.com)|(?:netflixparty\.com))$/)}(e)}function N(){return P(this,void 0,void 0,(function*(){return new Promise((e=>{chrome.permissions.contains({origins:f.$6},(n=>{e(n)}))}))}))}function _(e,n){return P(this,void 0,void 0,(function*(){const t=yield E();t&&(yield m.storeRedirectDataForTabAsync(e,t));const{sessionId:o,service:i}=e,r=new w(v,h,{sessionId:o,eventType:`redirect-${k}-${i}-chrome`}),c=new w(v,h,{name:"user_click",action:{description:`redirect-${k}-${i}-chrome`}});try{yield b.u(c,2500),yield b.u(r,2500)}finally{n("resolveRedirect")}}))}function E(){return P(this,void 0,void 0,(function*(){return new Promise((e=>{chrome.tabs.query({active:!0,currentWindow:!0},(function(n){const t=n[0].id;e(t)}))}))}))}window.addEventListener("message",(function(e){if(I(e)){const n=e.data;if(n){const t=function(e){return n=>{var t,o;if(e.data.callbackId){const o={callbackId:e.data.callbackId,data:n};null===(t=window.top)||void 0===t||t.postMessage(o,e.origin)}else null===(o=window.top)||void 0===o||o.postMessage(n,e.origin)}}(e);"Content_Script"===n.target||n.target===h?function(e,n){P(this,void 0,void 0,(function*(){const t=yield b.u(e);n(t)}))}(n,t):"SetRedirectData"==n.type?_(n.data,t):n.sessionId?_(n,t):"GetPermissions"===n.type?function(e,n){P(this,void 0,void 0,(function*(){const t=yield N(),o=t||(yield function(e){return P(this,void 0,void 0,(function*(){return new Promise((n=>{var t;const o=()=>P(this,void 0,void 0,(function*(){const t=`${"all_sites"}-${e}-chrome`,i=new T(v,h,{experimentName:"permissions_request",experimentVersion:t,eventType:"permissions-prompted"});b.u(i),chrome.permissions.request({origins:f.$6},(e=>{var i;null==e&&console.log(null===(i=chrome.runtime.lastError)||void 0===i?void 0:i.message);const r=new T(v,h,{experimentName:"permissions_request",experimentVersion:t,eventType:e?"permissions-granted":"permissions-denied"});b.u(r,2500).catch((()=>{})).then((()=>{var t;n(e),null===(t=document.querySelector("html"))||void 0===t||t.removeEventListener("click",o)}))}))}));null===(t=document.querySelector("html"))||void 0===t||t.addEventListener("click",o)}))}))}(n.site));e(o)}))}(t,n.data):"CheckHasPermissions"===n.type?N().then(t):"logExperiment"===n.type?function(e,n){P(this,void 0,void 0,(function*(){const{experimentName:t,experimentVersion:o,event:i}=e,r=new T(v,h,{experimentName:t,experimentVersion:o,eventType:i});try{yield b.u(r,2500)}finally{n()}}))}(n.data,t):"logEvent"===n.type?function(e,n){P(this,void 0,void 0,(function*(){const t=new w(v,h,e.event);try{b.u(t,2500)}finally{n()}}))}(n.data,t):"SetPermId"===n.type?function(e){P(this,void 0,void 0,(function*(){const n=yield o.getAllItemsAsync();n.userId||(n.userId=e)}))}(n.data):"storeExperimentVersion"===n.type?function(e,n){var t;P(this,void 0,void 0,(function*(){const{experimentName:i,experimentVersion:r}=e,s=yield o.getItemsAsync(["experiments"]),a=null!==(t=s.experiments)&&void 0!==t?t:{};a[i]=r;try{yield c.setItemsAsync({experiments:a})}finally{n()}}))}(n.data,t):"GetPermId"===n.type?function(e){P(this,void 0,void 0,(function*(){const n=(yield o.getAllItemsAsync()).userId;e(n)}))}(t):"GetActiveNetflixTabs"===n.type?function(e){chrome.tabs.query({url:S},(n=>{e(n)}))}(t):"CloseNetflixTabs"===n.type?function(e){chrome.tabs.query({url:S},(n=>{const t=n.map((e=>e.id)).filter((e=>!!e));chrome.tabs.remove(t),e()}))}(t):"AddSidebarHandler"===n.type?function(e,n){P(this,void 0,void 0,(function*(){D=e,A=yield E(),n(A)}))}(e.origin,t):t({error:"Unsupported Operation"})}}}),!1),b.addListener((function(e,n,t){if("TP_Sidebar"===e.target&&e.tabId===A){if(null!=D)return window.parent.postMessage(e,D),t(),!0;console.warn("Not ready yet")}return!1}))})();